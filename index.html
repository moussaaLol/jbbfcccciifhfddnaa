<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>NazAPI • Recherche Premium</title>
<meta name="color-scheme" content="dark light" />
<style>
  :root{
    --bg: #0b0f1a;
    --card: rgba(255,255,255,0.06);
    --card-strong: rgba(255,255,255,0.12);
    --text: #e8ecf1;
    --muted: #9fb2c8;
    --accent: #6de1ff;
    --ok: #3ad29f;
    --warn: #ffd166;
    --danger:#ff6b6b;
    --ring: rgba(109,225,255,.35);
    --shadow: 0 10px 30px rgba(0,0,0,.35), inset 0 0 0 1px rgba(255,255,255,.05);
    --radius: 18px;
  }
  html,body{height:100%}
  body{
    margin:0; font-family: ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Inter,Arial;
    color:var(--text); background: radial-gradient(1200px 800px at 15% -10%,#16223a 0%,transparent 60%),
                       radial-gradient(1000px 700px at 85% -5%,#1a2d4b 0%,transparent 60%),
                       radial-gradient(1200px 900px at 50% 110%,#111a2a 0%,transparent 60%), var(--bg);
    background-attachment: fixed;
    overflow-y: auto;
  }
  /* étoiles */
  .stars, .stars2, .stars3{
    position:fixed; inset:0; pointer-events:none; background-repeat:repeat; z-index:-1; opacity:.6;
    background-image: radial-gradient(1px 1px at 20px 30px,#fff,transparent 50%),
                      radial-gradient(1px 1px at 80px 120px,#fff,transparent 50%),
                      radial-gradient(1px 1px at 200px 80px,#fff,transparent 50%),
                      radial-gradient(1px 1px at 320px 40px,#fff,transparent 50%),
                      radial-gradient(1px 1px at 440px 160px,#fff,transparent 50%);
    animation: twinkle 16s linear infinite;
  }
  .stars2{ animation-duration:22s; opacity:.4; transform:scale(1.2) }
  .stars3{ animation-duration:30s; opacity:.25; transform:scale(1.4) }
  @keyframes twinkle { 0%{filter:brightness(.9)} 50%{filter:brightness(1.1)} 100%{filter:brightness(.9)} }

  .wrap{ max-width:1080px; margin:auto; padding:32px 20px 80px; }
  header{
    display:flex; gap:16px; align-items:center; justify-content:space-between; margin-bottom:24px;
  }
  .brand{ display:flex; align-items:center; gap:12px; }
  .logo{
    width:40px; height:40px; border-radius:12px; background:
      radial-gradient(18px 14px at 14px 14px, #6de1ff 0%, #4cc2ff 35%, transparent 60%),
      conic-gradient(from 220deg,#6de1ff, #7c6dff, #eb6cff, #6de1ff);
    box-shadow: 0 0 30px rgba(109,225,255,.4), inset 0 0 0 2px rgba(255,255,255,.07);
  }
  h1{ font-size:20px; margin:0; letter-spacing:.3px }
  .card{
    background: var(--card); border-radius: var(--radius); box-shadow: var(--shadow);
    backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px);
    padding:18px 18px; border:1px solid rgba(255,255,255,.06);
  }
  .stack{ display:grid; gap:16px; }
  .grid{ display:grid; gap:16px; grid-template-columns: 1.1fr .9fr; }
  @media (max-width:900px){ .grid{ grid-template-columns:1fr } }
  .muted{ color:var(--muted) }
  .btn{
    appearance:none; border:0; padding:12px 16px; border-radius:14px; font-weight:600; cursor:pointer;
    background: linear-gradient(180deg, #1d2a42, #141c2b); color:#eaf7ff;
    box-shadow: var(--shadow); transition: transform .05s ease, box-shadow .2s ease;
  }
  .btn:hover{ box-shadow: 0 14px 36px rgba(109,225,255,.25), inset 0 0 0 1px var(--ring) }
  .btn:active{ transform: translateY(1px) }
  .btn.secondary{ background: linear-gradient(180deg, #232b3b, #1a2230) }
  .btn.ok{ background: linear-gradient(180deg, #1f3a34, #122722) }
  .btn.danger{ background: linear-gradient(180deg, #3a2327, #2a1417) }
  .toolbar{ display:flex; gap:10px; align-items:center; flex-wrap:wrap }
  .pill{ padding:6px 10px; background: var(--card-strong); border-radius:999px; font-size:12px; }
  input[type="text"], input[type="search"]{
    width:100%; padding:12px 14px; border-radius:12px; border:1px solid rgba(255,255,255,.07);
    background: rgba(10,14,24,.6); color:var(--text); outline:none;
  }
  .footer{
    opacity:.85; margin-top:28px; padding:16px; text-align:center; font-size:13px; color:var(--muted)
  }
  .danger-text{ color:var(--danger) }
  .ok-text{ color:var(--ok) }
  .divider{ height:1px; background: rgba(255,255,255,.08); margin:12px 0 }
  .kbd{ background:rgba(255,255,255,.12); padding:2px 6px; border-radius:6px; font-size:12px }
  .sticky-key{ position:fixed; right:20px; bottom:20px; max-width:520px; z-index:50 }
  .hide{ display:none !important }
  .role-chip{ font-size:12px; padding:6px 10px; border-radius:999px; background:rgba(255,25,255,.1); }
  .code{ font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; }
</style>
</head>
<body>
<div class="stars"></div><div class="stars2"></div><div class="stars3"></div>

<div class="wrap">
  <header>
    <div class="brand">
      <div class="logo" aria-hidden="true"></div>
      <div>
        <h1>NazAPI — Recherche</h1>
        <div class="muted" style="font-size:13px">Recherche sur site • Accès réservé Premium</div>
      </div>
    </div>
    <div class="toolbar">
      <div id="userBadge" class="pill muted">Non connecté</div>
      <button id="loginBtn" class="btn">Se connecter avec Discord</button>
      <button id="logoutBtn" class="btn secondary hide">Se déconnecter</button>
    </div>
  </header>

  <div class="grid">
    <section class="card stack">
      <div style="display:flex;justify-content:space-between;align-items:center;gap:12px">
        <div>
          <div style="font-weight:700">État de compte</div>
          <div class="muted" style="font-size:13px">Connexion</div>
        </div>
        <div id="rolesChips" class="toolbar"></div>
      </div>

      <div class="divider"></div>

      <div id="accountState">
        <div class="muted">Connecte-toi avec Discord pour vérifier ton accés au site.</div>
      </div>

      <div id="purchaseBlock" class="hide">
        <div style="display:flex;justify-content:space-between;align-items:center;gap:16px;flex-wrap:wrap">
          <div>
            <div style="font-weight:700;font-size:16px">Premium NazAPI — 16,99 €</div>
            <div class="muted" style="font-size:13px">30 jours • 300 recherches/jour • support prioritaire</div>
          </div>
          <div class="toolbar">
            <button id="buyBtn" class="btn ok">Acheter maintenant</button>
            <button id="haveKeyBtn" class="btn secondary">J’ai déjà une clé</button>
          </div>
        </div>
        <div class="muted" style="font-size:12px">Paiement sécurisé via Stripe.</div>
      </div>

      <div id="activationBlock" class="hide">
        <div style="display:flex;gap:10px;align-items:center">
          <input id="keyInput" type="text" placeholder="VOTRE_CLÉ (32 caractères)" maxlength="32" />
          <button id="activateKeyBtn" class="btn">Activer</button>
        </div>
        <div id="activationMsg" class="muted" style="font-size:13px;margin-top:8px"></div>
      </div>
    </section>

    <section class="card stack" id="searchCard">
      <div style="display:flex;justify-content:space-between;align-items:center;gap:12px">
        <div>
          <div style="font-weight:700">Recherche sur le site</div>
          <div class="muted" style="font-size:13px">Réservé aux membres Premium connectés</div>
        </div>
        <div class="pill">Beta</div>
      </div>

      <div id="searchGate" class="muted">Accès verrouillé. Connecte-toi et assure-toi d’avoir le rôle <span class="code">Premium</span> ou <span class="code">VIP</span>.</div>

      <div id="searchUI" class="hide">
        <div style="display:flex; gap:10px; align-items:center">
          <input id="q" type="search" placeholder="Terme à chercher…" />
          <button id="doSearch" class="btn">Chercher</button>
        </div>
        <div id="progress" class="muted" style="margin-top:8px;font-size:13px"></div>
        <div id="results" class="stack" style="margin-top:10px"></div>
      </div>
    </section>
  </div>

  <footer class="footer">
    <div>© <span id="year"></span> NazAPI • <span class="muted">research services ✦</span></div>
  </footer>
</div>

<div id="stickyKey" class="sticky-key card hide">
  <div style="display:flex;justify-content:space-between;align-items:center;gap:12px">
    <div style="font-weight:700">Votre clé Premium</div>
    <button id="closeSticky" class="btn secondary" style="padding:6px 10px">Fermer</button>
  </div>
  <div class="divider"></div>
  <div class="code" id="stickyKeyValue" style="word-break:break-all;font-size:14px"></div>
  <div class="muted" style="font-size:12px;margin-top:8px">Copiez cette clé et conservez-la en lieu sûr.</div>
</div>
<script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-functions-compat.js"></script>

<script>
  const functions = require('firebase-functions');
const admin = require('firebase-admin');
const { Storage } = require('@google-cloud/storage');
const cors = require('cors')({ origin: true }); // Importez le middleware CORS

admin.initializeApp();
const storage = new Storage();
const bucketName = 'nazapi-fc74e.appspot.com';

/**
 * Fonction HTTP callable pour la recherche de fichiers dans Storage.
 * Elle prend en paramètre un objet de données contenant le terme de recherche.
 */
exports.searchFiles = functions.https.onCall(async (data, context) => {
    
    // Le middleware CORS s'exécute automatiquement pour les fonctions HTTPS Callable
    // mais il est utile de le voir ici pour comprendre ce qui se passe.
    // L'en-tête 'Access-Control-Allow-Origin' est géré par onCall.

    // Vérification de l'authentification
    if (!context.auth) {
        throw new functions.https.HttpsError('unauthenticated', 'La fonction requiert une authentification.');
    }

    const searchTerm = (data.query || '').toLowerCase();
    if (searchTerm.length < 2) {
        throw new functions.https.HttpsError('invalid-argument', 'Le terme de recherche est trop court.');
    }

    const bucket = storage.bucket(bucketName);
    const foundResults = [];

    const [files] = await bucket.getFiles();

    for (const file of files) {
        try {
            if (file.metadata.contentType.startsWith('image/') || file.metadata.size > 1000000) {
                continue;
            }

            const fileContent = await file.download();
            const contentString = fileContent.toString('utf8');
            const lines = contentString.split('\n');
            let lineNumber = 0;

            for (const line of lines) {
                lineNumber++;
                if (line.toLowerCase().includes(searchTerm)) {
                    foundResults.push({
                        nom: file.name.split('/').pop(),
                        chemin: file.name,
                        ligne: `Ligne ${lineNumber}: ${line.trim()}`,
                        downloadUrl: await file.getSignedUrl({
                            action: 'read',
                            expires: Date.now() + 1000 * 60 * 5
                        })
                    });
                    break;
                }
            }
        } catch (error) {
            console.error(`Erreur lors de la lecture du fichier ${file.name}:`, error);
        }
    }

    return { results: foundResults };
});
</script>
</body>
</html>
