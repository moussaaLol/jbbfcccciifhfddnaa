<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>NazAPI • Recherche Premium</title>
<meta name="color-scheme" content="dark light" />
<script src="https://js.stripe.com/v3/"></script>
<style>
  :root{
    --bg: #0b0f1a;
    --card: rgba(255,255,255,0.06);
    --card-strong: rgba(255,255,255,0.12);
    --text: #e8ecf1;
    --muted: #9fb2c8;
    --accent: #6de1ff;
    --ok: #3ad29f;
    --warn: #ffd166;
    --danger:#ff6b6b;
    --ring: rgba(109,225,255,.35);
    --shadow: 0 10px 30px rgba(0,0,0,.35), inset 0 0 0 1px rgba(255,255,255,.05);
    --radius: 18px;
  }
  html,body{height:100%}
  body{
    margin:0; font-family: ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Inter,Arial;
    color:var(--text); background: radial-gradient(1200px 800px at 15% -10%,#16223a 0%,transparent 60%),
                       radial-gradient(1000px 700px at 85% -5%,#1a2d4b 0%,transparent 60%),
                       radial-gradient(1200px 900px at 50% 110%,#111a2a 0%,transparent 60%), var(--bg);
    background-attachment: fixed;
    overflow-y: auto;
  }
  /* étoiles */
  .stars, .stars2, .stars3{
    position:fixed; inset:0; pointer-events:none; background-repeat:repeat; z-index:-1; opacity:.6;
    background-image: radial-gradient(1px 1px at 20px 30px,#fff,transparent 50%),
                      radial-gradient(1px 1px at 80px 120px,#fff,transparent 50%),
                      radial-gradient(1px 1px at 200px 80px,#fff,transparent 50%),
                      radial-gradient(1px 1px at 320px 40px,#fff,transparent 50%),
                      radial-gradient(1px 1px at 440px 160px,#fff,transparent 50%);
    animation: twinkle 16s linear infinite;
  }
  .stars2{ animation-duration:22s; opacity:.4; transform:scale(1.2) }
  .stars3{ animation-duration:30s; opacity:.25; transform:scale(1.4) }
  @keyframes twinkle { 0%{filter:brightness(.9)} 50%{filter:brightness(1.1)} 100%{filter:brightness(.9)} }

  .wrap{ max-width:1080px; margin:auto; padding:32px 20px 80px; }
  header{
    display:flex; gap:16px; align-items:center; justify-content:space-between; margin-bottom:24px;
  }
  .brand{ display:flex; align-items:center; gap:12px; }
  .logo{
    width:40px; height:40px; border-radius:12px; background:
      radial-gradient(18px 14px at 14px 14px, #6de1ff 0%, #4cc2ff 35%, transparent 60%),
      conic-gradient(from 220deg,#6de1ff, #7c6dff, #eb6cff, #6de1ff);
    box-shadow: 0 0 30px rgba(109,225,255,.4), inset 0 0 0 2px rgba(255,255,255,.07);
  }
  h1{ font-size:20px; margin:0; letter-spacing:.3px }
  .card{
    background: var(--card); border-radius: var(--radius); box-shadow: var(--shadow);
    backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px);
    padding:18px 18px; border:1px solid rgba(255,255,255,.06);
  }
  .stack{ display:grid; gap:16px; }
  .grid{ display:grid; gap:16px; grid-template-columns: 1.1fr .9fr; }
  @media (max-width:900px){ .grid{ grid-template-columns:1fr } }
  .muted{ color:var(--muted) }
  .btn{
    appearance:none; border:0; padding:12px 16px; border-radius:14px; font-weight:600; cursor:pointer;
    background: linear-gradient(180deg, #1d2a42, #141c2b); color:#eaf7ff;
    box-shadow: var(--shadow); transition: transform .05s ease, box-shadow .2s ease;
  }
  .btn:hover{ box-shadow: 0 14px 36px rgba(109,225,255,.25), inset 0 0 0 1px var(--ring) }
  .btn:active{ transform: translateY(1px) }
  .btn.secondary{ background: linear-gradient(180deg, #232b3b, #1a2230) }
  .btn.ok{ background: linear-gradient(180deg, #1f3a34, #122722) }
  .btn.danger{ background: linear-gradient(180deg, #3a2327, #2a1417) }
  .toolbar{ display:flex; gap:10px; align-items:center; flex-wrap:wrap }
  .pill{ padding:6px 10px; background: var(--card-strong); border-radius:999px; font-size:12px; }
  input[type="text"], input[type="search"], textarea {
    width:100%; padding:12px 14px; border-radius:12px; border:1px solid rgba(255,255,255,.07);
    background: rgba(10,14,24,.6); color:var(--text); outline:none;
    font-family: inherit;
  }
  textarea { min-height: 100px; resize: vertical; }
  .footer{ opacity:.85; margin-top:28px; padding:16px; text-align:center; font-size:13px; color:var(--muted) }
  .danger-text{ color:var(--danger) }
  .ok-text{ color:var(--ok) }
  .divider{ height:1px; background: rgba(255,255,255,.08); margin:12px 0 }
  .kbd{ background:rgba(255,255,255,.12); padding:2px 6px; border-radius:6px; font-size:12px }
  .sticky-key{ position:fixed; right:20px; bottom:20px; max-width:520px; z-index:50 }
  .hide{ display:none !important }
  .role-chip{ font-size:12px; padding:6px 6px; border-radius:999px; background:rgba(255,25,255,.1); }
  .code{ font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; }
  /* Contact card */
  .contact-card { background: linear-gradient(135deg, rgba(255,255,255,0.08), rgba(255,255,255,0.04)); border: 1px solid rgba(255,255,255,0.1); padding: 16px; border-radius: var(--radius); text-align: center; }
  .discord-btn { display: inline-flex; align-items: center; gap: 8px; background: #5865F2; color: white; padding: 10px 16px; border-radius: 12px; text-decoration: none; font-weight: 600; margin-top: 12px; transition: all 0.2s ease; }
  .discord-btn:hover { background: #4752c4; transform: translateY(-2px); box-shadow: 0 4px 12px rgba(88, 101, 242, 0.3); }
  /* Loading */
  .loading-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg); display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 9999; transition: opacity 0.5s ease; }
  .loading-spinner { width: 50px; height: 50px; border: 3px solid rgba(109, 225, 255, 0.3); border-radius: 50%; border-top-color: var(--accent); animation: spin 1s ease-in-out infinite; margin-bottom: 20px; }
  @keyframes spin { to { transform: rotate(360deg); } }
  .loading-text { font-size: 18px; color: var(--text); text-align: center; }
  .loading-dots:after { content: ''; animation: dots 1.5s infinite; }
  @keyframes dots { 0%, 20% { content: '.'; } 40% { content: '..'; } 60%, 100% { content: '...'; } }
  /* Role status */
  .role-status { padding: 10px; border-radius: 12px; margin-top: 12px; font-size: 14px; text-align: center; }
  .role-status.updating { background: rgba(255, 209, 102, 0.1); color: var(--warn); }
  .role-status.success { background: rgba(58, 210, 159, 0.1); color: var(--ok); }
  .role-status.error { background: rgba(255, 107, 107, 0.1); color: var(--danger); }
  /* Vouches */
  .vouch-section { margin-top: 30px; }
  .vouch-form { background: var(--card); padding: 20px; border-radius: var(--radius); margin-bottom: 20px; }
  .vouch-list { display: grid; gap: 16px; }
  .vouch-item { background: var(--card); padding: 16px; border-radius: var(--radius); position: relative; }
  .vouch-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
  .vouch-user { display: flex; align-items: center; gap: 10px; }
  .vouch-avatar { width: 32px; height: 32px; border-radius: 50%; background: linear-gradient(45deg, #6de1ff, #7c6dff); }
  .vouch-name { font-weight: 600; }
  .vouch-date { font-size: 12px; color: var(--muted); }
  .vouch-content { margin: 10px 0; line-height: 1.5; }
  .vouch-delete { position: absolute; top: 16px; right: 16px; background: rgba(255, 107, 107, 0.2); border: none; border-radius: 6px; padding: 4px 8px; color: var(--danger); cursor: pointer; font-size: 12px; }
  .vouch-delete:hover { background: rgba(255, 107, 107, 0.3); }
  .no-vouches { text-align: center; padding: 30px; color: var(--muted); }
  .char-count { text-align: right; font-size: 12px; color: var(--muted); margin-top: 5px; }
  .char-count.warning { color: var(--warn); }
  .char-count.error { color: var(--danger); }
  /* Stripe popup (matching design) */
  .popup-payment { position: fixed; inset: 0; background: rgba(0,0,0,.6); display: none; justify-content: center; align-items: center; z-index: 9999; }
  .popup-content { background: var(--card); border:1px solid rgba(255,255,255,.06); box-shadow: var(--shadow); border-radius: var(--radius); width: 100%; max-width: 460px; padding: 18px; }
  #payment-element { padding: 8px; background: rgba(10,14,24,.6); border:1px solid rgba(255,255,255,.07); border-radius: 12px; }
  #paymentMessage { font-size: 13px; color: var(--muted); min-height: 18px; }
</style>
</head>
<body>
<div class="stars"></div><div class="stars2"></div><div class="stars3"></div>

<div id="loadingScreen" class="loading-screen">
  <div class="loading-spinner"></div>
  <div class="loading-text">Chargement de NazAPI<span class="loading-dots"></span></div>
</div>

<div class="wrap">
  <header>
    <div class="brand">
      <div class="logo" aria-hidden="true"></div>
      <div>
        <h1>NazAPI — Recherche</h1>
        <div class="muted" style="font-size:13px">Recherche sur site • Accès réservé Premium</div>
      </div>
    </div>
    <div class="toolbar">
      <div id="userBadge" class="pill muted">Non connecté</div>
      <button id="loginBtn" class="btn">Se connecter avec Discord</button>
      <button id="logoutBtn" class="btn secondary hide">Se déconnecter</button>
    </div>
  </header>

  <div class="grid">
    <section class="card stack">
      <div style="display:flex;justify-content:space-between;align-items:center;gap:12px">
        <div>
          <div style="font-weight:700">État de compte</div>
          <div class="muted" style="font-size:13px">Connexion</div>
        </div>
        <div id="rolesChips" class="toolbar"></div>
      </div>

      <div class="divider"></div>

      <div id="accountState">
        <div class="muted">Connecte-toi avec Discord pour vérifier ton accés au site.</div>
      </div>

      <div id="purchaseBlock" class="hide">
        <div style="display:flex;justify-content:space-between;align-items:center;gap:16px;flex-wrap:wrap">
          <div>
            <div style="font-weight:700;font-size:16px">Premium NazAPI — 16,99 €</div>
            <div class="muted" style="font-size:13px">30 jours • 300 recherches/jour • support prioritaire</div>
          </div>
          <div class="toolbar">
            <button id="buyBtn" class="btn ok">Acheter maintenant</button>
            <button id="haveKeyBtn" class="btn secondary">J’ai déjà une clé</button>
          </div>
        </div>
        <div class="muted" style="font-size:12px">Paiement sécurisé via Stripe.</div>
      </div>

      <div id="activationBlock" class="hide">
        <div style="display:flex;gap:10px;align-items:center">
          <input id="keyInput" type="text" placeholder="VOTRE_CLÉ (32 caractères)" maxlength="32" />
          <button id="activateKeyBtn" class="btn">Activer</button>
        </div>
        <div id="activationMsg" class="muted" style="font-size:13px;margin-top:8px"></div>
        <div id="roleAssignmentStatus" class="role-status hide"></div>
      </div>
      
      <div class="contact-card">
        <div style="font-weight:700;margin-bottom:8px">Vous n'avez pas reçu votre clé?</div>
        <div class="muted" style="font-size:13px">Contactez-nous sur Discord pour obtenir de l'aide</div>
        <a href="https://discord.gg/your-server-link" target="_blank" class="discord-btn">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor">
            <path d="M19.27 5.33C17.94 4.71 16.5 4.26 15 4a.09.09 0 0 0-.07.03c-.18.33-.39.76-.53 1.09a16.09 16.09 0 0 0-4.8 0c-.14-.34-.35-.76-.54-1.09c-.01-.02-.04-.03-.07-.03c-1.5.26-2.93.71-4.27 1.33c-.01 0-.02.01-.03.02C2.44 8.78 1.71 12.23 2.04 15.64c0 .02.01.04.03.05c1.57 1.15 3.1 1.84 4.59 2.3c.03.01.06 0 .07-.02c.4-.55.76-1.13 1.07-1.74c.02-.04 0-.08-.04-.09c-.57-.22-1.11-.48-1.64-.78c-.04-.02-.04-.08-.01-.11c.11-.08.22-.17.33-.25c.02-.02.05-.02.07-.01c3.44 1.57 7.15 1.57 10.55 0c.02-.01.05-.01.07.01c.11.09.22.17.33.26c.04.03.04.09-.01.11c-.52.31-1.07.56-1.64.78c-.04.01-.05.06-.04.09c.32.61.67 1.19 1.07 1.74c.03.01.06.02.09.01c1.5-.46 3.02-1.15 4.59-2.3c.02-.01.03-.03.03-.05c.4-3.9-.67-7.25-2.73-10.29c-.01-.02-.02-.02-.04-.02zm-10.56 8.18c-1.03 0-1.89-.95-1.89-2.12s.84-2.12 1.89-2.12c1.06 0 1.9.96 1.89 2.12c0 1.17-.84 2.12-1.89 2.12zm6.59 0c-1.03 0-1.89-.95-1.89-2.12s.84-2.12 1.89-2.12c1.06 0 1.9.96 1.89 2.12c0 1.17-.83 2.12-1.89 2.12z"/>
          </svg>
          Rejoindre le Discord
        </a>
      </div>
    </section>

    <section class="card stack" id="searchCard">
      <div style="display:flex;justify-content:space-between;align-items:center;gap:12px">
        <div>
          <div style="font-weight:700">Recherche sur le site</div>
          <div class="muted" style="font-size:13px">Réservé aux membres Premium </div>
        </div>
        <div class="pill">Beta</div>
      </div>

      <div id="searchGate" class="muted">Accès verrouillé. Connecte-toi et assure-toi d’avoir le rôle <span class="code">Premium</span> ou <span class="code">VIP</span>.</div>

      <div id="searchUI" class="hide">
        <div style="display:flex; gap:10px; align-items:center">
          <input id="q" type="search" placeholder="Terme à chercher…" />
          <button id="doSearch" class="btn">Chercher</button>
        </div>
        <div id="progress" class="muted" style="margin-top:8px;font-size:13px"></div>
        <div id="results" class="stack" style="margin-top:10px"></div>
      </div>
    </section>
  </div>

  <section id="vouchSection" class="vouch-section hide">
    <h2 style="margin-bottom: 20px;">vouches de la communauté</h2>
    
    <div id="vouchForm" class="vouch-form hide">
      <h3 style="margin-bottom: 15px;">Laissez votre vouch</h3>
      <textarea id="vouchText" placeholder="Partagez votre expérience avec NazAPI..." maxlength="500"></textarea>
      <div id="vouchCharCount" class="char-count">0/500</div>
      <button id="submitVouch" class="btn" style="margin-top: 15px;">Publier le vouch</button>
    </div>
    
    <div id="vouchList" class="vouch-list">
      <div class="no-vouches">Aucun vouch pour le moment.</div>
    </div>
  </section>

  <footer class="footer">
    <div>© <span id="year"></span> NazAPI • <span class="muted">research services ✦</span></div>
  </footer>
</div>

<div id="stickyKey" class="sticky-key card hide">
  <div style="display:flex;justify-content:space-between;align-items:center;gap:12px">
    <div style="font-weight:700">Votre clé Premium</div>
    <button id="closeSticky" class="btn secondary" style="padding:6px 10px">Fermer</button>
  </div>
  <div class="divider"></div>
  <div class="code" id="stickyKeyValue" style="word-break:break-all;font-size:14px"></div>
  <div class="muted" style="font-size:12px;margin-top:8px">Copiez cette clé et conservez-la en lieu sûr.</div>
</div>

<div id="paymentPopup" class="popup-payment">
  <div class="popup-content">
    <div style="display:flex;justify-content:space-between;align-items:center;gap:12px; margin-bottom:6px;">
      <h3 style="margin:0">Paiement Premium</h3>
      <button id="closePaymentBtn" class="btn secondary" style="padding:8px 10px">Fermer</button>
    </div>
    <div class="muted" style="font-size:13px;margin-bottom:8px">Montant : <span class="ok-text">16,99 €</span></div>
    <div id="payment-element" style="padding: 8px; background: rgba(10,14,24,.6); border:1px solid rgba(255,255,255,.07); border-radius: 12px;"></div>
    <div id="paymentMessage" style="margin-top:10px"></div>
    <button id="confirmPaymentBtn" class="btn ok" style="margin-top:12px;width:100%">Payer 16,99 €</button>
  </div>
</div>

<script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-functions-compat.js"></script>

<script type="module">
  // Import Firebase modules for modular SDK
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
  import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
  import { getFirestore, doc, setDoc, onSnapshot, collection, query, addDoc, serverTimestamp, orderBy } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

  // --- Helper Functions ---
  const $ = (s, c = document) => c.querySelector(s);
  const $$ = (s, c = document) => c.querySelectorAll(s);

  // --- UI Elements ---
  const loadingScreen = $("#loadingScreen");
  const accountState = $("#accountState");
  const purchaseBlock = $("#purchaseBlock");
  const activationBlock = $("#activationBlock");
  const searchGate = $("#searchGate");
  const searchUI = $("#searchUI");
  const userBadge = $("#userBadge");
  const rolesChips = $("#rolesChips");
  const loginBtn = $("#loginBtn");
  const logoutBtn = $("#logoutBtn");
  const buyBtn = $("#buyBtn");
  const haveKeyBtn = $("#haveKeyBtn");
  const activateKeyBtn = $("#activateKeyBtn");
  const keyInput = $("#keyInput");
  const activationMsg = $("#activationMsg");
  const roleAssignmentStatus = $("#roleAssignmentStatus");
  const stickyKey = $("#stickyKey");
  const stickyKeyValue = $("#stickyKeyValue");
  const closeSticky = $("#closeSticky");
  const searchInput = $("#q");
  const doSearchBtn = $("#doSearch");
  const progress = $("#progress");
  const resultsDiv = $("#results");
  const vouchSection = $("#vouchSection");
  const vouchForm = $("#vouchForm");
  const vouchTextarea = $("#vouchText");
  const vouchCharCount = $("#vouchCharCount");
  const submitVouchBtn = $("#submitVouch");
  const vouchList = $("#vouchList");
  const paymentPopup = $("#paymentPopup");
  const closePaymentBtn = $("#closePaymentBtn");
  const confirmPaymentBtn = $("#confirmPaymentBtn");
  const paymentMessage = $("#paymentMessage");

  // --- Firebase & App State Variables ---
  let firebaseApp, auth, db, userId;
  let userRoles = [];
  let userDiscordId = "mock_discord_user_id"; // Mock Discord ID for demonstration

  const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
  const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
  const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

  // --- Main App Logic ---

  /**
   * Shows the loading screen.
   */
  function showLoadingScreen() {
    loadingScreen.classList.remove("hide");
  }

  /**
   * Hides the loading screen.
   */
  function hideLoadingScreen() {
    loadingScreen.classList.add("hide");
  }

  /**
   * Updates the UI to show a logged-in state.
   */
  function setLoggedInUI(user) {
    userBadge.textContent = user.displayName || user.email || user.uid;
    loginBtn.classList.add("hide");
    logoutBtn.classList.remove("hide");
    accountState.classList.add("hide");
    purchaseBlock.classList.add("hide");
    activationBlock.classList.add("hide");
    vouchSection.classList.remove("hide");
    vouchForm.classList.remove("hide");

    // Check for "Premium" or "VIP" roles to grant search access
    const hasPremiumAccess = userRoles.includes("Premium") || userRoles.includes("VIP");
    if (hasPremiumAccess) {
      searchGate.classList.add("hide");
      searchUI.classList.remove("hide");
    } else {
      searchGate.classList.remove("hide");
      searchUI.classList.add("hide");
    }
  }

  /**
   * Updates the UI to show a logged-out state.
   */
  function setLoggedOutUI() {
    userBadge.textContent = "Non connecté";
    rolesChips.innerHTML = "";
    loginBtn.classList.remove("hide");
    logoutBtn.classList.add("hide");
    accountState.classList.remove("hide");
    purchaseBlock.classList.remove("hide");
    activationBlock.classList.add("hide");
    searchGate.classList.remove("hide");
    searchUI.classList.add("hide");
    vouchSection.classList.remove("hide");
    vouchForm.classList.add("hide");
  }

  /**
   * Renders the user's roles as chips.
   * @param {Array<string>} roles The list of user roles.
   */
  function renderRoles(roles) {
    rolesChips.innerHTML = roles.map(role => `<div class="role-chip">${role}</div>`).join("");
  }

  /**
   * Handles mock Discord login.
   * @returns {Promise<void>}
   */
  async function mockDiscordLogin() {
    showLoadingScreen();
    // Simulate API call and role assignment
    await new Promise(resolve => setTimeout(resolve, 1500));
    // Set mock user data and roles
    const mockUser = {
      uid: userDiscordId,
      displayName: "DiscordUser"
    };
    userRoles = ["Membre", "Premium"];
    renderRoles(userRoles);
    setLoggedInUI(mockUser);
    hideLoadingScreen();
  }

  /**
   * Mocks a premium key activation.
   * @param {string} key The key to activate.
   */
  async function activateExistingKeyForUser(key) {
    showLoadingScreen("Activation de votre clé...");
    await new Promise(resolve => setTimeout(resolve, 1500));

    // Simulate role assignment
    roleAssignmentStatus.textContent = "Attribution des rôles...";
    roleAssignmentStatus.classList.remove("hide", "success", "error");
    roleAssignmentStatus.classList.add("updating");

    await new Promise(resolve => setTimeout(resolve, 1000));
    userRoles.push("Premium"); // Add the Premium role
    renderRoles(userRoles);

    roleAssignmentStatus.textContent = "Rôle Premium attribué avec succès!";
    roleAssignmentStatus.classList.remove("updating");
    roleAssignmentStatus.classList.add("success");
    setLoggedInUI({ uid: userDiscordId, displayName: "DiscordUser" });
    hideLoadingScreen();
  }

  /**
   * Mocks a Stripe payment process.
   */
  async function confirmStripePayment() {
    paymentMessage.textContent = "Vérification du paiement en cours...";
    paymentMessage.classList.remove("ok-text", "danger-text");
    await new Promise(resolve => setTimeout(resolve, 2000));
    paymentMessage.textContent = "Paiement réussi! Création de votre clé...";
    paymentMessage.classList.add("ok-text");
    await new Promise(resolve => setTimeout(resolve, 1500));

    // Generate a mock key
    const mockKey = Array.from({ length: 32 }, () => "ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789"[Math.floor(Math.random() * 36)]).join('');
    stickyKeyValue.textContent = mockKey;
    paymentPopup.style.display = "none";
    stickyKey.classList.remove("hide");
    
    // Auto-activate the key
    await activateExistingKeyForUser(mockKey);
  }

  /**
   * Mocks the search functionality.
   * @param {string} query The search query.
   */
  async function runSearch(query) {
    progress.textContent = `Recherche de "${query}"...`;
    resultsDiv.innerHTML = "";
    await new Promise(resolve => setTimeout(resolve, 2000));
    
    const mockResults = [
      { title: "Résultat 1 pour " + query, url: "#", snippet: "Ceci est le premier résultat de recherche." },
      { title: "Résultat 2 pour " + query, url: "#", snippet: "Ceci est le deuxième résultat de recherche, avec plus de détails." },
      { title: "Résultat 3 pour " + query, url: "#", snippet: "Un autre résultat, mais pour la troisième fois." },
    ];

    resultsDiv.innerHTML = mockResults.map(r => `
      <div class="card stack" style="padding:12px">
        <div style="font-weight:600"><a href="${r.url}" style="color:var(--accent);text-decoration:none">${r.title}</a></div>
        <div class="muted" style="font-size:13px">${r.snippet}</div>
      </div>
    `).join("");
    progress.textContent = `${mockResults.length} résultats trouvés.`;
  }

  /**
   * Sets up the character counter for the vouch textarea.
   */
  function setupVouchCharacterCounter() {
    const maxChars = vouchTextarea.maxLength;
    vouchTextarea.addEventListener("input", () => {
      const currentChars = vouchTextarea.value.length;
      vouchCharCount.textContent = `${currentChars}/${maxChars}`;
      vouchCharCount.classList.toggle("warning", currentChars > maxChars * 0.8 && currentChars < maxChars);
      vouchCharCount.classList.toggle("error", currentChars >= maxChars);
    });
  }

  /**
   * Renders the vouches from Firestore.
   * @param {Array<Object>} vouches The list of vouch documents.
   */
  function renderVouches(vouches) {
    if (vouches.length === 0) {
      vouchList.innerHTML = `<div class="no-vouches">Aucun vouch pour le moment.</div>`;
      return;
    }

    const html = vouches.map(vouch => {
      const date = vouch.timestamp?.toDate ? vouch.timestamp.toDate().toLocaleDateString() : new Date().toLocaleDateString();
      const isOwner = userId === vouch.userId;
      const deleteBtn = isOwner ? `<button class="vouch-delete" onclick="deleteVouch('${vouch.id}')">Supprimer</button>` : '';
      const userName = vouch.userName || "Utilisateur anonyme";

      return `
        <div class="vouch-item">
          <div class="vouch-header">
            <div class="vouch-user">
              <div class="vouch-avatar"></div>
              <div class="vouch-name">${userName}</div>
            </div>
            <div class="vouch-date">${date}</div>
          </div>
          <div class="vouch-content">${vouch.content}</div>
          ${deleteBtn}
        </div>
      `;
    }).join("");
    vouchList.innerHTML = html;
  }

  /**
   * Submits a new vouch to Firestore.
   */
  async function submitVouch() {
    const content = vouchTextarea.value.trim();
    if (content.length < 10) {
      alert("Vouch trop court. Il doit contenir au moins 10 caractères.");
      return;
    }

    submitVouchBtn.disabled = true;
    submitVouchBtn.textContent = "Publication...";

    try {
      const vouchesCollection = collection(db, `artifacts/${appId}/public/data/vouches`);
      await addDoc(vouchesCollection, {
        userId: userId,
        userName: `User_${userId.substring(0, 4)}`, // A simple display name
        content: content,
        timestamp: serverTimestamp()
      });
      vouchTextarea.value = "";
      alert("Vouch publié avec succès!");
    } catch (e) {
      console.error("Erreur lors de la publication du vouch:", e);
      alert("Une erreur s'est produite lors de la publication.");
    } finally {
      submitVouchBtn.disabled = false;
      submitVouchBtn.textContent = "Publier le vouch";
    }
  }

  /**
   * Deletes a vouch from Firestore.
   * @param {string} vouchId The ID of the vouch to delete.
   */
  window.deleteVouch = async (vouchId) => {
    // Custom modal instead of alert
    if (confirm("Êtes-vous sûr de vouloir supprimer ce vouch?")) {
      try {
        await deleteDoc(doc(db, `artifacts/${appId}/public/data/vouches`, vouchId));
      } catch (e) {
        console.error("Erreur lors de la suppression du vouch:", e);
        alert("Une erreur s'est produite lors de la suppression.");
      }
    }
  }

  // --- Event Listeners ---
  loginBtn.addEventListener("click", mockDiscordLogin);
  logoutBtn.addEventListener("click", () => {
    signOut(auth);
    setLoggedOutUI();
    // Simulate sticky key close if it's open
    stickyKey.classList.add('hide');
  });

  haveKeyBtn.addEventListener("click", () => {
    accountState.classList.add("hide");
    purchaseBlock.classList.add("hide");
    activationBlock.classList.remove("hide");
  });

  activateKeyBtn.addEventListener("click", async () => {
    const key = (keyInput.value || '').trim().toUpperCase();
    activationMsg.classList.remove('ok-text', 'danger-text');
    activationMsg.textContent = '';
    roleAssignmentStatus.classList.add('hide');
    try {
      if (!key || key.length !== 32) throw new Error('Clé invalide (32 caractères requis).');
      await activateExistingKeyForUser(key);
      activationMsg.classList.add('ok-text');
      activationMsg.textContent = '✅ Clé activée avec succès!';
    } catch (e) {
      activationMsg.classList.add('danger-text');
      activationMsg.textContent = '❌ ' + e.message;
    }
  });

  buyBtn.addEventListener("click", () => {
    paymentPopup.style.display = "flex";
  });

  closePaymentBtn.addEventListener("click", () => {
    paymentPopup.style.display = "none";
  });

  confirmPaymentBtn.addEventListener("click", confirmStripePayment);

  closeSticky.addEventListener("click", () => {
    stickyKey.classList.add("hide");
  });

  doSearchBtn.addEventListener("click", () => runSearch(searchInput.value));

  submitVouchBtn.addEventListener("click", submitVouch);

  // --- Initialization ---
  (async function init() {
    showLoadingScreen();
    setLoggedOutUI();
    document.getElementById("year").textContent = new Date().getFullYear();
    setupVouchCharacterCounter();

    // Firebase Initialization
    if (Object.keys(firebaseConfig).length) {
      firebaseApp = initializeApp(firebaseConfig);
      auth = getAuth(firebaseApp);
      db = getFirestore(firebaseApp);

      // Listen for auth state changes
      onAuthStateChanged(auth, async (user) => {
        if (user) {
          userId = user.uid;
          console.log("User authenticated with UID:", userId);
          // Simulate user data fetch from a backend (to get roles)
          // In a real app, you would fetch roles from a secure endpoint
          userRoles = ["Membre", "VIP"]; // Mock roles for authenticated user
          renderRoles(userRoles);
          setLoggedInUI(user);
        } else {
          // If no user, sign in anonymously to interact with public data
          try {
             await signInAnonymously(auth);
          } catch(e) {
             console.error("Failed to sign in anonymously:", e);
          }
          console.log("User signed out or failed to auth, handling public data.");
          setLoggedOutUI();
          // The onAuthStateChanged listener will fire again with the anonymous user
        }
      });
      
      // Real-time listener for vouches
      const vouchesCollection = collection(db, `artifacts/${appId}/public/data/vouches`);
      onSnapshot(query(vouchesCollection), (querySnapshot) => {
        const vouches = [];
        querySnapshot.forEach((doc) => {
          vouches.push({ id: doc.id, ...doc.data() });
        });
        // Sort vouches by timestamp in descending order before rendering
        vouches.sort((a, b) => (b.timestamp?.toDate() || 0) - (a.timestamp?.toDate() || 0));
        renderVouches(vouches);
      }, (error) => {
        console.error("Error fetching vouches:", error);
        vouchList.innerHTML = `<div class="no-vouches danger-text">Erreur de chargement des vouches.</div>`;
      });
      
    } else {
      console.error("Firebase config is missing. The app will not function correctly.");
    }
    
    // Simulate initial authentication process
    if (initialAuthToken) {
      try {
        await signInWithCustomToken(auth, initialAuthToken);
      } catch (e) {
        console.error("Custom token sign-in failed:", e);
        // Fallback to anonymous sign-in
        await signInAnonymously(auth);
      }
    }

    hideLoadingScreen();
  })();
</script>
</body>
</html>
