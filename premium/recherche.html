<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>NazAPI • Recherche Premium</title>
<meta name="color-scheme" content="dark light" />
<script src="https://js.stripe.com/v3/"></script>
<style>
/* Les styles CSS que vous avez fournis */
:root {
    --bg: #0b0f1a;
    --card: rgba(255, 255, 255, 0.06);
    --card-strong: rgba(255, 255, 255, 0.12);
    --text: #e8ecf1;
    --muted: #9fb2c8;
    --accent: #6de1ff;
    --ok: #3ad29f;
    --warn: #ffd166;
    --danger: #ff6b6b;
    --ring: rgba(109, 225, 255, .35);
    --shadow: 0 10px 30px rgba(0, 0, 0, .35), inset 0 0 0 1px rgba(255, 255, 255, .05);
    --radius: 18px;
}
html, body {
    height: 100%;
}
body {
    margin: 0;
    font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Inter, Arial;
    color: var(--text);
    background: radial-gradient(1200px 800px at 15% -10%, #16223a 0%, transparent 60%), radial-gradient(1000px 700px at 85% -5%, #1a2d4b 0%, transparent 60%), radial-gradient(1200px 900px at 50% 110%, #111a2a 0%, transparent 60%), var(--bg);
    background-attachment: fixed;
    overflow-y: auto;
}
/* étoiles */
.stars, .stars2, .stars3 {
    position: fixed;
    inset: 0;
    pointer-events: none;
    background-repeat: repeat;
    z-index: -1;
    opacity: .6;
    background-image: radial-gradient(1px 1px at 20px 30px, #fff, transparent 50%), radial-gradient(1px 1px at 80px 120px, #fff, transparent 50%), radial-gradient(1px 1px at 200px 80px, #fff, transparent 50%), radial-gradient(1px 1px at 320px 40px, #fff, transparent 50%), radial-gradient(1px 1px at 440px 160px, #fff, transparent 50%);
    animation: twinkle 16s linear infinite;
}
.stars2 {
    animation-duration: 22s;
    opacity: .4;
    transform: scale(1.2);
}
.stars3 {
    animation-duration: 30s;
    opacity: .25;
    transform: scale(1.4);
}
@keyframes twinkle {
    0% {
        filter: brightness(.9);
    }
    50% {
        filter: brightness(1.1);
    }
    100% {
        filter: brightness(.9);
    }
}
.wrap {
    max-width: 1080px;
    margin: auto;
    padding: 32px 20px 80px;
}
header {
    display: flex;
    gap: 16px;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 24px;
}
.brand {
    display: flex;
    align-items: center;
    gap: 12px;
}
.logo {
    width: 40px;
    height: 40px;
    border-radius: 12px;
    background: radial-gradient(18px 14px at 14px 14px, #6de1ff 0%, #4cc2ff 35%, transparent 60%), conic-gradient(from 220deg, #6de1ff, #7c6dff, #eb6cff, #6de1ff);
    box-shadow: 0 0 30px rgba(109, 225, 255, .4), inset 0 0 0 2px rgba(255, 255, 255, .07);
}
h1 {
    font-size: 20px;
    margin: 0;
    letter-spacing: .3px;
}
.card {
    background: var(--card);
    border-radius: var(--radius);
    box-shadow: var(--shadow);
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
    padding: 18px 18px;
    border: 1px solid rgba(255, 255, 255, .06);
}
.stack {
    display: grid;
    gap: 16px;
}
.grid {
    display: grid;
    gap: 16px;
    grid-template-columns: 1.1fr .9fr;
}
@media (max-width: 900px) {
    .grid {
        grid-template-columns: 1fr;
    }
}
.muted {
    color: var(--muted);
}
.btn {
    appearance: none;
    border: 0;
    padding: 12px 16px;
    border-radius: 14px;
    font-weight: 600;
    cursor: pointer;
    background: linear-gradient(180deg, #1d2a42, #141c2b);
    color: #eaf7ff;
    box-shadow: var(--shadow);
    transition: transform .05s ease, box-shadow .2s ease;
}
.btn:hover {
    box-shadow: 0 14px 36px rgba(109, 225, 255, .25), inset 0 0 0 1px var(--ring);
}
.btn:active {
    transform: translateY(1px);
}
.btn.secondary {
    background: linear-gradient(180deg, #232b3b, #1a2230);
}
.btn.ok {
    background: linear-gradient(180deg, #1f3a34, #122722);
}
.btn.danger {
    background: linear-gradient(180deg, #3a2327, #2a1417);
}
.toolbar {
    display: flex;
    gap: 10px;
    align-items: center;
    flex-wrap: wrap;
}
.pill {
    padding: 6px 10px;
    background: var(--card-strong);
    border-radius: 999px;
    font-size: 12px;
}
input[type="text"],
input[type="search"],
textarea {
    width: 100%;
    padding: 12px 14px;
    border-radius: 12px;
    border: 1px solid rgba(255, 255, 255, .07);
    background: rgba(10, 14, 24, .6);
    color: var(--text);
    outline: none;
    font-family: inherit;
}
textarea {
    min-height: 100px;
    resize: vertical;
}
.footer {
    opacity: .85;
    margin-top: 28px;
    padding: 16px;
    text-align: center;
    font-size: 13px;
    color: var(--muted);
}
.danger-text {
    color: var(--danger);
}
.ok-text {
    color: var(--ok);
}
.divider {
    height: 1px;
    background: rgba(255, 255, 255, .08);
    margin: 12px 0;
}
.kbd {
    background: rgba(255, 255, 255, .12);
    padding: 2px 6px;
    border-radius: 6px;
    font-size: 12px;
}
.sticky-key {
    position: fixed;
    right: 20px;
    bottom: 20px;
    max-width: 520px;
    z-index: 50;
}
.hide {
    display: none !important;
}
.role-chip {
    font-size: 12px;
    padding: 6px 10px;
    border-radius: 999px;
    background: rgba(255, 25, 255, .1);
}
.code {
    font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
}
/* Contact card */
.contact-card {
    background: linear-gradient(135deg, rgba(255, 255, 255, 0.08), rgba(255, 255, 255, 0.04));
    border: 1px solid rgba(255, 255, 255, 0.1);
    padding: 16px;
    border-radius: var(--radius);
    text-align: center;
}
.discord-btn {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    background: #5865F2;
    color: white;
    padding: 10px 16px;
    border-radius: 12px;
    text-decoration: none;
    font-weight: 600;
    margin-top: 12px;
    transition: all 0.2s ease;
}
.discord-btn:hover {
    background: #4752c4;
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(88, 101, 242, 0.3);
}
/* Loading */
.loading-screen {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: var(--bg);
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    z-index: 9999;
    transition: opacity 0.5s ease;
}
.loading-spinner {
    width: 50px;
    height: 50px;
    border: 3px solid rgba(109, 225, 255, 0.3);
    border-radius: 50%;
    border-top-color: var(--accent);
    animation: spin 1s ease-in-out infinite;
    margin-bottom: 20px;
}
@keyframes spin {
    to {
        transform: rotate(360deg);
    }
}
.loading-text {
    font-size: 18px;
    color: var(--text);
    text-align: center;
}
.loading-dots:after {
    content: '';
    animation: dots 1.5s infinite;
}
@keyframes dots {
    0%, 20% {
        content: '.';
    }
    40% {
        content: '..';
    }
    60%, 100% {
        content: '...';
    }
}
/* Role status */
.role-status {
    padding: 10px;
    border-radius: 12px;
    margin-top: 12px;
    font-size: 14px;
    text-align: center;
}
.role-status.updating {
    background: rgba(255, 209, 102, 0.1);
    color: var(--warn);
}
.role-status.success {
    background: rgba(58, 210, 159, 0.1);
    color: var(--ok);
}
.role-status.error {
    background: rgba(255, 107, 107, 0.1);
    color: var(--danger);
}
/* Vouches */
.vouch-section {
    margin-top: 30px;
}
.vouch-form {
    background: var(--card);
    padding: 20px;
    border-radius: var(--radius);
    margin-bottom: 20px;
}
.vouch-list {
    display: grid;
    gap: 16px;
}
.vouch-item {
    background: var(--card);
    padding: 16px;
    border-radius: var(--radius);
    position: relative;
}
.vouch-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 10px;
}
.vouch-user {
    display: flex;
    align-items: center;
    gap: 10px;
}
.vouch-avatar {
    width: 32px;
    height: 32px;
    border-radius: 50%;
    background: linear-gradient(45deg, #6de1ff, #7c6dff);
}
.vouch-name {
    font-weight: 600;
}
.vouch-date {
    font-size: 12px;
    color: var(--muted);
}
.vouch-content {
    margin: 10px 0;
    line-height: 1.5;
}
.vouch-delete {
    position: absolute;
    top: 16px;
    right: 16px;
    background: rgba(255, 107, 107, 0.2);
    border: none;
    border-radius: 6px;
    padding: 4px 8px;
    color: var(--danger);
    cursor: pointer;
    font-size: 12px;
}
.vouch-delete:hover {
    background: rgba(255, 107, 107, 0.3);
}
.no-vouches {
    text-align: center;
    padding: 30px;
    color: var(--muted);
}
.char-count {
    text-align: right;
    font-size: 12px;
    color: var(--muted);
    margin-top: 5px;
}
.char-count.warning {
    color: var(--warn);
}
.char-count.error {
    color: var(--danger);
}
/* Stripe popup (matching design) */
.popup-payment {
    position: fixed;
    inset: 0;
    background: rgba(0, 0, 0, .6);
    display: none;
    justify-content: center;
    align-items: center;
    z-index: 9999;
}
.popup-content {
    background: var(--card);
    border: 1px solid rgba(255, 255, 255, .06);
    box-shadow: var(--shadow);
    border-radius: var(--radius);
    width: 100%;
    max-width: 460px;
    padding: 18px;
}
#payment-element {
    padding: 8px;
    background: rgba(10, 14, 24, .6);
    border: 1px solid rgba(255, 255, 255, .07);
    border-radius: 12px;
}
#paymentMessage {
    font-size: 13px;
    color: var(--muted);
    min-height: 18px;
}
/* Result box */
.result-box {
    background: rgba(255, 255, 255, 0.05);
    border: 1px solid rgba(255, 255, 255, 0.08);
    border-radius: 12px;
    padding: 16px;
    margin-top: 16px;
    position: relative;
}
.result-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 12px;
}
.result-copy-btn {
    background: rgba(109, 225, 255, 0.15);
    border: none;
    border-radius: 8px;
    padding: 6px 12px;
    color: var(--accent);
    cursor: pointer;
    font-size: 12px;
    font-weight: 600;
    transition: all 0.2s ease;
}
.result-copy-btn:hover {
    background: rgba(109, 225, 255, 0.25);
}
.result-content {
    font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
    white-space: pre-wrap;
    word-break: break-all;
    font-size: 13px;
    line-height: 1.5;
}
.no-results {
    text-align: center;
    padding: 30px;
    color: var(--muted);
}
</style>
</head>
<body>
<div class="stars"></div>
<div class="stars2"></div>
<div class="stars3"></div>

<div id="loadingScreen" class="loading-screen">
    <div class="loading-spinner"></div>
    <div class="loading-text">Chargement de NazAPI<span class="loading-dots"></span></div>
</div>

<div class="wrap">
    <header>
        <div class="brand">
            <div class="logo" aria-hidden="true"></div>
            <div>
                <h1>NazAPI — Recherche Premium</h1>
                <div class="muted" style="font-size:13px">Recherche dans la base de données • Accès réservé Premium</div>
            </div>
        </div>
        <div class="toolbar">
            <div id="userBadge" class="pill muted">Non connecté</div>
            <button id="loginBtn" class="btn">Se connecter avec Discord</button>
            <button id="logoutBtn" class="btn secondary hide">Se déconnecter</button>
        </div>
    </header>

    <div class="grid">
        <section class="card stack">
            <div style="display:flex;justify-content:space-between;align-items:center;gap:12px">
                <div>
                    <div style="font-weight:700">État de compte</div>
                    <div class="muted" style="font-size:13px">Connexion</div>
                </div>
                <div id="rolesChips" class="toolbar"></div>
            </div>

            <div class="divider"></div>

            <div id="accountState">
                <div class="muted">Connecte-toi avec Discord pour vérifier ton accés au site.</div>
            </div>

            <div id="purchaseBlock" class="hide">
                <div style="display:flex;justify-content:space-between;align-items:center;gap:16px;flex-wrap:wrap">
                    <div>
                        <div style="font-weight:700;font-size:16px">Premium NazAPI — 16,99 €</div>
                        <div class="muted" style="font-size:13px">30 jours • 300 recherches/jour • support prioritaire</div>
                    </div>
                    <div class="toolbar">
                        <button id="buyBtn" class="btn ok">Acheter maintenant</button>
                        <button id="haveKeyBtn" class="btn secondary">J'ai déjà une clé</button>
                    </div>
                </div>
                <div class="muted" style="font-size:12px">Paiement sécurisé via Stripe.</div>
            </div>

            <div id="activationBlock" class="hide">
                <div style="display:flex;gap:10px;align-items:center">
                    <input id="keyInput" type="text" placeholder="VOTRE_CLÉ (32 caractères)" maxlength="32" />
                    <button id="activateKeyBtn" class="btn">Activer</button>
                </div>
                <div id="activationMsg" class="muted" style="font-size:13px;margin-top:8px"></div>
                <div id="roleAssignmentStatus" class="role-status hide"></div>
            </div>

            <div class="contact-card">
                <div style="font-weight:700;margin-bottom:8px">Vous n'avez pas reçu votre clé?</div>
                <div class="muted" style="font-size:13px">Contactez-nous sur Discord pour obtenir de l'aide</div>
                <a href="https://discord.gg/PbUDwjWnWd" target="_blank" class="discord-btn">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M19.27 5.33C17.94 4.71 16.5 4.26 15 4a.09.09 0 0 0-.07.03c-.18.33-.39.76-.53 1.09a16.09 16.09 0 0 0-4.8 0c-.14-.34-.35-.76-.54-1.09c-.01-.02-.04-.03-.07-.03c-1.5.26-2.93.71-4.27 1.33c-.01 0-.02.01-.03.02C2.44 8.78 1.71 12.23 2.04 15.64c0 .02.01.04.03.05c1.57 1.15 3.1 1.84 4.59 2.3c.03.01.06 0 .07-.02c.4-.55.76-1.13 1.07-1.74c.02-.04 0-.08-.04-.09c-.57-.22-1.11-.48-1.64-.78c-.04-.02-.04-.08-.01-.11c.11-.08.22-.17.33-.25c.02-.02.05-.02.07-.01c3.44 1.57 7.15 1.57 10.55 0c.02-.01.05-.01.07.01c.11.09.22.17.33.26c.04.03.04.09-.01.11c-.52.31-1.07.56-1.64.78c-.04.01-.05.06-.04.09c.32.61.67 1.19 1.07 1.74c.03.01.06.02.09.01c1.5-.46 3.02-1.15 4.59-2.3c.02-.01.03-.03.03-.05c.4-3.9-.67-7.25-2.73-10.29c-.01-.02-.02-.02-.04-.02zm-10.56 8.18c-1.03 0-1.89-.95-1.89-2.12s.84-2.12 1.89-2.12c1.06 0 1.9.96 1.89 2.12c0 1.17-.84 2.12-1.89 2.12zm6.59 0c-1.03 0-1.89-.95-1.89-2.12s.84-2.12 1.89-2.12c1.06 0 1.9.96 1.89 2.12c0 1.17-.83 2.12-1.89 2.12z" />
                    </svg>
                    Rejoindre le Discord
                </a>
            </div>
        </section>

        <section class="card stack" id="searchCard">
            <div style="display:flex;justify-content:space-between;align-items:center;gap:12px">
                <div>
                    <div style="font-weight:700">Recherche Premium</div>
                    <div class="muted" style="font-size:13px">Recherche dans la base de données</div>
                </div>
                <div class="pill">Premium</div>
            </div>

            <div id="searchGate" class="muted">Accès verrouillé. Connecte-toi et assure-toi d'avoir le rôle <span class="code">Premium</span> ou <span class="code">VIP</span>.</div>

            <div id="searchUI" class="hide">
                <div style="display:flex; gap:10px; align-items:center">
                    <input id="searchInput" type="search" placeholder="Entrez un email, nom, etc..." />
                    <button id="searchBtn" class="btn">Rechercher</button>
                </div>
                <div id="searchProgress" class="muted" style="margin-top:8px;font-size:13px"></div>
                <div id="searchResults" class="stack" style="margin-top:10px">
                    <div class="no-results">Aucune recherche effectuée.</div>
                </div>
            </div>
        </section>
    </div>

    <section id="vouchSection" class="vouch-section hide">
        <h2 style="margin-bottom: 20px;">Témoignages de la communauté</h2>

        <div id="vouchForm" class="vouch-form hide">
            <h3 style="margin-bottom: 15px;">Laissez votre témoignage</h3>
            <textarea id="vouchText" placeholder="Partagez votre expérience avec NazAPI..." maxlength="500"></textarea>
            <div id="vouchCharCount" class="char-count">0/500</div>
            <button id="submitVouch" class="btn" style="margin-top: 15px;">Publier le témoignage</button>
        </div>

        <div id="vouchList" class="vouch-list">
            <div class="no-vouches">Aucun témoignage pour le moment.</div>
        </div>
    </section>

    <footer class="footer">
        <div>© <span id="year"></span> NazAPI • <span class="muted">services de recherche ✦</span></div>
    </footer>
</div>

<div id="stickyKey" class="sticky-key card hide">
    <div style="display:flex;justify-content:space-between;align-items:center;gap:12px">
        <div style="font-weight:700">Votre clé Premium</div>
        <button id="closeSticky" class="btn secondary" style="padding:6px 10px">Fermer</button>
    </div>
    <div class="divider"></div>
    <div class="code" id="stickyKeyValue" style="word-break:break-all;font-size:14px"></div>
    <div class="muted" style="font-size:12px;margin-top:8px">Copiez cette clé et conservez-la en lieu sûr.</div>
</div>

<div id="paymentPopup" class="popup-payment">
    <div class="popup-content">
        <div style="display:flex;justify-content:space-between;align-items:center;gap:12px; margin-bottom:6px;">
            <h3 style="margin:0">Paiement Premium</h3>
            <button id="closePaymentBtn" class="btn secondary" style="padding:8px 10px">Fermer</button>
        </div>
        <div class="muted" style="font-size:13px;margin-bottom:8px">Montant : <span class="ok-text">16,99 €</span></div>
        <div id="payment-element" style="padding: 8px; background: rgba(10,14,24,.6); border:1px solid rgba(255,255,255,.07); border-radius: 12px;"></div>
        <div id="paymentMessage" style="margin-top:10px"></div>
        <button id="confirmPaymentBtn" class="btn ok" style="margin-top:12px;width:100%">Payer 16,99 €</button>
    </div>
</div>

<script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-functions-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-storage-compat.js"></script>

<script>
/** =========================
 * CONFIGURATION
 * ========================= */
const DISCORD = {
  CLIENT_ID: '1407764995671986249',
  GUILD_ID: '1406489247543984240',
  SCOPES: ['identify', 'guilds.members.read'],
  REDIRECT_URI: window.location.origin + window.location.pathname,
  PREMIUM_ROLE_ID: '1406489247573086400',
  VIP_ROLE_ID: '1406489247564824669',
  MOD_ROLE_ID: '1406489247598252069'
};

const STRIPE = {
  PUBLIC_KEY: 'pk_test_51Rys3a1EC7Cm7d9GpJkkTiJHhlAdD4aaRmKYvaAQownN4JmUK6R18VMB8K6RJ94iC5F6hxMarSCvv5lLc55zjlIF00wrJIQC07',
  CREATE_PAYMENT_INTENT_URL: '/create-payment-intent'
};

const FIREBASE_CFG = {
  apiKey: "AIzaSyBtVmI_0_9qC6Cj5lmYgbwVJlW8lH11Ouw",
  authDomain: "nazapi-fc74e.firebaseapp.com",
  projectId: "nazapi-fc74e",
  storageBucket: "nazapi-fc74e.firebasestorage.app",
  appId: "1:1011679210688:web:eeccc40063f83b91e3d125",
};

const LICENSES_PATH = '/artifacts/' + ('default-app-id') + '/public/data/licenses';
const VOUCHES_PATH = 'vouches';
const THIRTY_DAYS_MS = 2592000000;
const SEARCH_LIMIT_PER_DAY = 300;

/** =========================
 * UTILITAIRES
 * ========================= */
const $ = sel => document.querySelector(sel);
const sleep = (ms) => new Promise(r => setTimeout(r, ms));
const toHexUpper = (buf) => [...new Uint8Array(buf)].map(b => b.toString(16).padStart(2, '0')).join('').toUpperCase();

function generateLicenseKey() {
  const arr = new Uint8Array(16);
  crypto.getRandomValues(arr);
  return toHexUpper(arr.buffer);
}

function formatDate(timestamp) {
  if (!timestamp) return '';
  const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
  return new Intl.DateTimeFormat('fr-FR', { day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit' }).format(date);
}

// Firebase
firebase.initializeApp(FIREBASE_CFG);
const db = firebase.firestore();
const auth = firebase.auth();
const functions = firebase.functions();
const storage = firebase.storage();

/** =========================
 * GESTION DES RECHERCHES
 * ========================= */
async function performSearch(searchTerm) {
  if (!searchTerm || searchTerm.trim().length < 2) {
    $('#searchProgress').textContent = 'Terme de recherche trop court (min. 2 caractères).';
    return;
  }

  $('#searchProgress').textContent = 'Recherche en cours...';
  $('#searchResults').innerHTML = '';

  try {
    const user = auth.currentUser;
    if (!user) {
      throw new Error("Utilisateur non authentifié.");
    }

    const today = new Date().toISOString().split('T')[0];
    const userDocRef = db.collection('users').doc(user.uid);
    const userDoc = await userDocRef.get();
    const userData = userDoc.data() || {};
    const searchCount = userData.searchCounts?.[today] || 0;

    if (searchCount >= SEARCH_LIMIT_PER_DAY) {
      $('#searchProgress').textContent = `Limite de ${SEARCH_LIMIT_PER_DAY} recherches par jour atteinte.`;
      return;
    }

    // Appeler la fonction cloud pour rechercher dans Firebase Storage
    const searchFunction = functions.httpsCallable('searchInFiles');
    const response = await searchFunction({ query: searchTerm });
    const results = response.data.results;

    // Incrémenter le compteur de recherches dans Firestore
    await userDocRef.set({
      searchCounts: {
        [today]: firebase.firestore.FieldValue.increment(1)
      }
    }, { merge: true });

    // Mettre à jour l'interface avec le nouveau nombre de recherches restantes
    const remainingSearches = SEARCH_LIMIT_PER_DAY - (searchCount + 1);
    $('#searchProgress').textContent = `Recherche terminée - ${results.length} résultat(s) trouvé(s). Il vous reste ${remainingSearches} recherches.`;

    if (!results || results.length === 0) {
      $('#searchResults').innerHTML = '<div class="no-results">Aucun résultat trouvé pour "' + searchTerm + '".</div>';
      return;
    }

    // Afficher les résultats
    results.forEach(result => {
      const resultElement = document.createElement('div');
      resultElement.className = 'result-box';
      resultElement.innerHTML = `
        <div class="result-header">
          <div class="muted" style="font-size:12px">Fichier: ${result.fileName}</div>
          <button class="result-copy-btn" data-content="${escapeHtml(result.matchingLine)}">Copier</button>
        </div>
        <div class="result-content">${result.matchingLine}</div>
      `;
      $('#searchResults').appendChild(resultElement);
    });

    // Ajouter les écouteurs d'événements pour les boutons de copie
    document.querySelectorAll('.result-copy-btn').forEach(btn => {
      btn.addEventListener('click', function() {
        const content = this.getAttribute('data-content');
        copyToClipboard(content);
        this.textContent = 'Copié!';
        setTimeout(() => {
          this.textContent = 'Copier';
        }, 2000);
      });
    });

  } catch (error) {
    console.error('Erreur lors de la recherche:', error);
    $('#searchProgress').textContent = 'Erreur lors de la recherche: ' + error.message;
    $('#searchResults').innerHTML = '<div class="no-results">Une erreur s\'est produite lors de la recherche.</div>';
  }
}

function escapeHtml(text) {
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}

function copyToClipboard(text) {
  const textarea = document.createElement('textarea');
  textarea.value = text;
  document.body.appendChild(textarea);
  textarea.select();
  document.execCommand('copy');
  document.body.removeChild(textarea);
}

/** =========================
 * AUTRES FONCTIONS (Discord, Stripe, etc.)
 * ========================= */
let stripe;
let elements;

// Stripe
async function openStripePopupAndInitElements() {
  $('#paymentPopup').style.display = 'flex';
  if (!stripe) stripe = Stripe(STRIPE.PUBLIC_KEY);
  try {
    const response = await fetch(STRIPE.CREATE_PAYMENT_INTENT_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ amount: 1699, currency: 'eur' })
    });
    const { clientSecret } = await response.json();
    elements = stripe.elements({ clientSecret });
    const paymentElement = elements.create('payment');
    paymentElement.mount('#payment-element');
    $('#confirmPaymentBtn').disabled = false;
    $('#paymentMessage').textContent = '';
  } catch (e) {
    $('#paymentMessage').textContent = 'Erreur de connexion au paiement.';
    console.error(e);
  }
}
async function confirmStripePayment() {
  $('#confirmPaymentBtn').disabled = true;
  $('#paymentMessage').textContent = 'Traitement de votre paiement...';
  const { error } = await stripe.confirmPayment({
    elements,
    confirmParams: { return_url: window.location.href }
  });
  if (error) {
    $('#paymentMessage').textContent = error.message;
    $('#confirmPaymentBtn').disabled = false;
  }
}
async function handleStripeSuccess() {
  const urlParams = new URLSearchParams(window.location.search);
  const paymentId = urlParams.get('payment_intent');
  if (paymentId) {
    showLoadingScreen('Vérification du paiement...');
    try {
      await markPaymentAsUsed(paymentId);
      history.replaceState({}, document.title, window.location.pathname);
    } catch (e) {
      console.error('Stripe success error:', e);
    }
  }
}
async function markPaymentAsUsed(paymentIntentId) {
  const user = auth.currentUser;
  if (!user || !discordUser) throw new Error('Utilisateur non connecté.');
  const docRef = db.collection('payments').doc(paymentIntentId);
  const doc = await docRef.get();
  if (doc.exists && doc.data().used) {
    console.log('Payment already used.'); return;
  }
  await docRef.set({
    userId: user.uid,
    discordId: discordUser.id,
    dateUsed: firebase.firestore.Timestamp.now(),
    used: true
  });
  const licenseKey = generateLicenseKey();
  await db.collection(LICENSES_PATH).doc(licenseKey).set({
    created: firebase.firestore.Timestamp.now(),
    creatorId: discordUser.id,
    usedBy: null
  });
  $('#stickyKeyValue').textContent = licenseKey;
  $('#stickyKey').classList.remove('hide');
  await assignDiscordRole(DISCORD.PREMIUM_ROLE_ID);
}

// Discord
function loginDiscord() {
  const params = new URLSearchParams({ client_id: DISCORD.CLIENT_ID, response_type: 'token', redirect_uri: DISCORD.REDIRECT_URI, scope: DISCORD.SCOPES.join(' ') });
  window.location.href = `https://discord.com/oauth2/authorize?${params.toString()}`;
}
function parseImplicitToken() {
  if (window.location.hash.startsWith('#')) {
    const h = new URLSearchParams(window.location.hash.slice(1));
    if (h.get('access_token')) {
      const token = h.get('access_token');
      const tokenType = h.get('token_type') || 'Bearer';
      const expires = Number(h.get('expires_in') || 0);
      history.replaceState({}, document.title, window.location.pathname + window.location.search);
      return { token, tokenType, expires };
    }
  }
  return null;
}
async function fetchDiscordJSON(token, path) {
  const r = await fetch(`https://discord.com/api${path}`, { headers: { Authorization: `Bearer ${token}` } });
  if (!r.ok) throw new Error('Discord API error: ' + r.status);
  return r.json();
}
async function assignDiscordRole(roleId) {
  $('#roleAssignmentStatus').classList.remove('hide', 'success', 'error', 'updating');
  $('#roleAssignmentStatus').classList.add('updating');
  $('#roleAssignmentStatus').textContent = 'Attribution du rôle en cours...';
  try {
    const assignRoleFunction = functions.httpsCallable('assignDiscordRole');
    const response = await assignRoleFunction({ discordId: discordUser.id, roleId: roleId });
    if (response.data.success) {
      $('#roleAssignmentStatus').textContent = 'Rôle Premium attribué avec succès!';
      $('#roleAssignmentStatus').classList.remove('updating');
      $('#roleAssignmentStatus').classList.add('success');
      await sleep(2000);
      location.reload();
    } else {
      throw new Error(response.data.error || 'Erreur inconnue.');
    }
  } catch (e) {
    console.error('Failed to assign role:', e);
    $('#roleAssignmentStatus').textContent = 'Erreur: Impossible d\'attribuer le rôle. Contactez un modérateur.';
    $('#roleAssignmentStatus').classList.remove('updating');
    $('#roleAssignmentStatus').classList.add('error');
  }
}
function hasPremiumAccess() {
  const roles = discordMember?.roles || [];
  return roles.includes(DISCORD.PREMIUM_ROLE_ID) || roles.includes(DISCORD.VIP_ROLE_ID);
}
function hasModPermissions() {
  const roles = discordMember?.roles || [];
  return roles.includes(DISCORD.MOD_ROLE_ID);
}

// Vouches
async function loadVouches() {
  const vouchList = $('#vouchList');
  vouchList.innerHTML = '';
  try {
    const vouchesSnapshot = await db.collection(VOUCHES_PATH).orderBy('timestamp', 'desc').get();
    if (vouchesSnapshot.empty) {
      vouchList.innerHTML = '<div class="no-vouches">Aucun témoignage pour le moment.</div>';
      return;
    }
    vouchesSnapshot.forEach(doc => {
      const vouch = doc.data();
      const vouchElement = createVouchElement(doc.id, vouch);
      vouchList.appendChild(vouchElement);
    });
  } catch (e) {
    console.error('Error loading vouches:', e);
  }
}
function createVouchElement(id, vouch) {
  const vouchItem = document.createElement('div');
  vouchItem.className = 'vouch-item';
  const isOwner = discordUser && vouch.discordId === discordUser.id;
  const isMod = hasModPermissions();
  const deleteBtnHtml = (isOwner || isMod) ? `<button class="vouch-delete" data-id="${id}">Supprimer</button>` : '';
  vouchItem.innerHTML = `
    <div class="vouch-header">
      <div class="vouch-user">
        <img src="https://cdn.discordapp.com/avatars/${vouch.discordId}/${vouch.avatar}.png?size=32" class="vouch-avatar" alt="Avatar Discord de ${vouch.username}">
        <span class="vouch-name">${vouch.username}</span>
      </div>
      <div class="vouch-date muted">${formatDate(vouch.timestamp)}</div>
    </div>
    <div class="vouch-content">${vouch.content}</div>
    ${deleteBtnHtml}
  `;
  if (isOwner || isMod) {
    vouchItem.querySelector('.vouch-delete').addEventListener('click', () => deleteVouch(id));
  }
  return vouchItem;
}
async function submitVouch() {
  const vouchText = $('#vouchText').value;
  if (!vouchText || vouchText.length < 10) {
    alert('Votre témoignage doit contenir au moins 10 caractères.'); return;
  }
  try {
    const vouchFunction = functions.httpsCallable('submitVouch');
    await vouchFunction({
      content: vouchText,
      discordId: discordUser.id,
      username: `${discordUser.username}#${discordUser.discriminator}`,
      avatar: discordUser.avatar
    });
    $('#vouchText').value = '';
    loadVouches();
  } catch (e) {
    console.error('Error submitting vouch:', e);
    alert('Erreur lors de la soumission de votre témoignage.');
  }
}
async function deleteVouch(id) {
  if (!confirm('Êtes-vous sûr de vouloir supprimer ce témoignage?')) return;
  try {
    const deleteFunction = functions.httpsCallable('deleteVouch');
    await deleteFunction({ vouchId: id });
    loadVouches();
  } catch (e) {
    console.error('Error deleting vouch:', e);
    alert('Erreur lors de la suppression du témoignage.');
  }
}
function setupVouchCharacterCounter() {
  const textarea = $('#vouchText');
  const counter = $('#vouchCharCount');
  textarea.addEventListener('input', () => {
    const count = textarea.value.length;
    counter.textContent = `${count}/${textarea.maxLength}`;
    if (count > textarea.maxLength * 0.9) counter.classList.add('warning');
    else if (count > textarea.maxLength) counter.classList.add('error');
    else counter.classList.remove('warning', 'error');
  });
}
async function createLicenseForUser() {
  showLoadingScreen('Génération de votre clé...');
  const licenseFunction = functions.httpsCallable('createLicense');
  const response = await licenseFunction();
  const { key } = response.data;
  if (key) {
    $('#stickyKeyValue').textContent = key;
    $('#stickyKey').classList.remove('hide');
    hideLoadingScreen();
  }
}
async function activateExistingKeyForUser() {
  const key = $('#keyInput').value;
  if (!key || key.length !== 32) {
    $('#activationMsg').textContent = 'Clé invalide. Elle doit contenir 32 caractères.';
    return;
  }
  showLoadingScreen('Activation de la clé...');
  $('#activationMsg').textContent = 'Vérification de la clé en cours...';
  try {
    const activateFunction = functions.httpsCallable('activateLicense');
    const response = await activateFunction({ key });
    if (response.data.success) {
      $('#activationMsg').textContent = 'Clé activée avec succès!';
      await assignDiscordRole(DISCORD.PREMIUM_ROLE_ID);
    } else {
      $('#activationMsg').textContent = response.data.error || 'Erreur inconnue lors de l\'activation.';
    }
  } catch (e) {
    console.error('Activation error:', e);
    $('#activationMsg').textContent = e.message;
  } finally {
    hideLoadingScreen();
  }
}

/** =========================
 * UI & FLUX
 * ========================= */
const userBadge = $('#userBadge');
const loginBtn = $('#loginBtn');
const logoutBtn = $('#logoutBtn');
const rolesChips = $('#rolesChips');
const accountState = $('#accountState');
const purchaseBlock = $('#purchaseBlock');
const activationBlock = $('#activationBlock');
const searchGate = $('#searchGate');
const searchUI = $('#searchUI');
const results = $('#results');
const progress = $('#progress');
const stickyKey = $('#stickyKey');
const stickyKeyValue = $('#stickyKeyValue');
let discordAuth = null;
let discordUser = null;
let discordMember = null;
function saveSession() {
  sessionStorage.setItem('nazapi_discord_auth', JSON.stringify(discordAuth || null));
  sessionStorage.setItem('nazapi_discord_user', JSON.stringify(discordUser || null));
  sessionStorage.setItem('nazapi_discord_member', JSON.stringify(discordMember || null));
}
function loadSession() {
  try {
    discordAuth = JSON.parse(sessionStorage.getItem('nazapi_discord_auth') || 'null');
    discordUser = JSON.parse(sessionStorage.getItem('nazapi_discord_user') || 'null');
    discordMember = JSON.parse(sessionStorage.getItem('nazapi_discord_member') || 'null');
  } catch {}
}
function setLoggedOutUI() {
  userBadge.textContent = 'Non connecté';
  rolesChips.innerHTML = '';
  accountState.innerHTML = `<div class="muted">Connecte-toi avec Discord pour vérifier tes rôles sur le serveur.</div>`;
  purchaseBlock.classList.add('hide');
  activationBlock.classList.add('hide');
  searchGate.classList.remove('hide');
  searchUI.classList.add('hide');
  logoutBtn.classList.add('hide');
  loginBtn.classList.remove('hide');
  $('#vouchSection').classList.add('hide');
  $('#vouchForm').classList.add('hide');
}
function showRolesChips(member) {
  rolesChips.innerHTML = '';
  if (!member || !Array.isArray(member.roles)) return;
  member.roles.forEach(id => {
    const span = document.createElement('span');
    span.className = 'role-chip';
    span.textContent = (id === DISCORD.PREMIUM_ROLE_ID ? 'Premium' : (id === DISCORD.VIP_ROLE_ID ? 'VIP' : (id === DISCORD.MOD_ROLE_ID ? 'Mod' : 'Rôle ' + id)));
    rolesChips.appendChild(span);
  });
}
function setLoggedInUI(hasPremium) {
  userBadge.textContent = discordUser ? `${discordUser.username}#${discordUser.discriminator || '0'}` : 'Connecté';
  showRolesChips({
    roles: discordMember?.roles || []
  });
  logoutBtn.classList.remove('hide');
  loginBtn.classList.add('hide');
  $('#vouchSection').classList.remove('hide');
  if (hasPremium) {
    $('#vouchForm').classList.remove('hide');
    accountState.innerHTML = `<div class="ok-text">Accès Premium/VIP validé ✔</div><div class="muted" style="font-size:13px">Tu peux utiliser la recherche.</div>`;
    purchaseBlock.classList.add('hide');
    activationBlock.classList.add('hide');
    searchGate.classList.add('hide');
    searchUI.classList.remove('hide');
    updateSearchCountUI();
  } else {
    $('#vouchForm').classList.add('hide');
    accountState.innerHTML = `<div class="danger-text">Accès Premium requis</div><div class="muted" style="font-size:13px">Achète Premium (16,99 €) ou active une clé existante.</div>`;
    purchaseBlock.classList.remove('hide');
    activationBlock.classList.remove('hide');
    searchGate.classList.remove('hide');
    searchUI.classList.add('hide');
  }
  loadVouches();
}
async function updateFromDiscord(token) {
  try {
    showLoadingScreen('Connexion à Discord...');
    discordUser = await fetchDiscordJSON(token, '/users/@me');
    let memberObj = await fetchDiscordJSON(token, `/users/@me/guilds/${DISCORD.GUILD_ID}/member`);
    discordMember = {
      roles: (memberObj.roles || [])
    };
    saveSession();
    const hasPremium = hasPremiumAccess();
    setLoggedInUI(hasPremium);
    hideLoadingScreen();
  } catch (e) {
    console.error('Erreur Discord :', e);
    setLoggedOutUI();
    hideLoadingScreen();
  }
}
function logout() {
  discordAuth = discordUser = discordMember = null;
  saveSession();
  setLoggedOutUI();
}
async function updateSearchCountUI() {
  const user = auth.currentUser;
  if (!user) return;
  try {
    const today = new Date().toISOString().split('T')[0];
    const userDoc = await db.collection('users').doc(user.uid).get();
    const userData = userDoc.data() || {};
    const searchCount = userData.searchCounts?.[today] || 0;
    const remainingSearches = SEARCH_LIMIT_PER_DAY - searchCount;
    $('#searchProgress').textContent = `${remainingSearches} recherches restantes sur ${SEARCH_LIMIT_PER_DAY} aujourd'hui.`;
  } catch (e) {
    console.error('Erreur de mise à jour du compteur:', e);
  }
}

/** =========================
 * INITIALISATION
 * ========================= */
$('#year').textContent = new Date().getFullYear();

// Événements
$('#loginBtn').addEventListener('click', loginDiscord);
$('#logoutBtn').addEventListener('click', logout);
$('#searchBtn').addEventListener('click', () => performSearch($('#searchInput').value));
$('#closeSticky').addEventListener('click', () => $('#stickyKey').classList.add('hide'));
$('#buyBtn').addEventListener('click', openStripePopupAndInitElements);
$('#closePaymentBtn').addEventListener('click', () => $('#paymentPopup').style.display = 'none');
$('#confirmPaymentBtn').addEventListener('click', confirmStripePayment);
$('#haveKeyBtn').addEventListener('click', () => {
  $('#purchaseBlock').classList.add('hide');
  $('#activationBlock').classList.remove('hide');
});
$('#activateKeyBtn').addEventListener('click', activateExistingKeyForUser);
$('#submitVouch').addEventListener('click', submitVouch);

// Permettre la recherche avec la touche Entrée
$('#searchInput').addEventListener('keypress', (e) => {
  if (e.key === 'Enter') {
    performSearch($('#searchInput').value);
  }
});

setupVouchCharacterCounter();

// Initialisation
(async function init() {
  showLoadingScreen();
  setLoggedOutUI();
  try {
    await auth.signInAnonymously();
  } catch (e) {
    console.error('Erreur de connexion anonyme:', e);
  }

  const parsedToken = parseImplicitToken();
  if (parsedToken) {
    discordAuth = parsedToken;
    await updateFromDiscord(discordAuth.token);
  } else {
    loadSession();
    if (discordAuth?.token) {
      await updateFromDiscord(discordAuth.token);
    } else {
      hideLoadingScreen();
    }
  }

  await handleStripeSuccess();
})();
</script>
</body>
</html>
