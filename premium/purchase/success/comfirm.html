<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>NazAPI • Confirmation</title>
<meta name="color-scheme" content="dark light" />
<style>
  :root{
    --bg: #0b0f1a;
    --card: rgba(255,255,255,0.06);
    --card-strong: rgba(255,255,255,0.12);
    --text: #e8ecf1;
    --muted: #9fb2c8;
    --accent: #6de1ff;
    --ok: #3ad29f;
    --warn: #ffd166;
    --danger:#ff6b6b;
    --ring: rgba(109,225,255,.35);
    --shadow: 0 10px 30px rgba(0,0,0,.35), inset 0 0 0 1px rgba(255,255,255,.05);
    --radius: 18px;
  }
  html,body{height:100%}
  body{
    margin:0; font-family: ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Inter,Arial;
    color:var(--text); background: radial-gradient(1200px 800px at 15% -10%,#16223a 0%,transparent 60%),
            radial-gradient(1000px 700px at 85% -5%,#1a2d4b 0%,transparent 60%),
            radial-gradient(1200px 900px at 50% 110%,#111a2a 0%,transparent 60%), var(--bg);
    background-attachment: fixed;
    overflow-y: auto;
    display: flex;
    justify-content: center;
    align-items: center;
    min-height: 100vh;
  }
  .stars, .stars2, .stars3{
    position:fixed; inset:0; pointer-events:none; background-repeat:repeat; z-index:-1; opacity:.6;
    background-image: radial-gradient(1px 1px at 20px 30px,#fff,transparent 50%),
              radial-gradient(1px 1px at 80px 120px,#fff,transparent 50%),
              radial-gradient(1px 1px at 200px 80px,#fff,transparent 50%),
              radial-gradient(1px 1px at 320px 40px,#fff,transparent 50%),
              radial-gradient(1px 1px at 440px 160px,#fff,transparent 50%);
    animation: twinkle 16s linear infinite;
  }
  .stars2{ animation-duration:22s; opacity:.4; transform:scale(1.2) }
  .stars3{ animation-duration:30s; opacity:.25; transform:scale(1.4) }
  @keyframes twinkle { 0%{filter:brightness(.9)} 50%{filter:brightness(1.1)} 100%{filter:brightness(.9)} }

  .wrap{ max-width:600px; margin:auto; padding:32px 20px; }
  .brand{ display:flex; align-items:center; gap:12px; justify-content: center; margin-bottom: 30px; }
  .logo{
    width:60px; height:60px; border-radius:16px; background:
      radial-gradient(18px 14px at 14px 14px, #6de1ff 0%, #4cc2ff 35%, transparent 60%),
      conic-gradient(from 220deg,#6de1ff, #7c6dff, #eb6cff, #6de1ff);
    box-shadow: 0 0 30px rgba(109,225,255,.4), inset 0 0 0 2px rgba(255,255,255,.07);
  }
  h1{ font-size:28px; margin:0; letter-spacing:.3px; text-align: center; }
  .card{
    background: var(--card); border-radius: var(--radius); box-shadow: var(--shadow);
    backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px);
    padding:40px 30px; border:1px solid rgba(255,255,255,.06);
    text-align: center;
  }
  .muted{ color:var(--muted) }
  .btn{
    appearance:none; border:0; padding:12px 24px; border-radius:14px; font-weight:600; cursor:pointer;
    background: linear-gradient(180deg, #1d2a42, #141c2b); color:#eaf7ff;
    box-shadow: var(--shadow); transition: transform .05s ease, box-shadow .2s ease;
    margin-top: 20px;
  }
  .btn:hover{ box-shadow: 0 14px 36px rgba(109,225,255,.25), inset 0 0 0 1px var(--ring) }
  .btn:active{ transform: translateY(1px) }
  .btn.ok{ background: linear-gradient(180deg, #1f3a34, #122722) }
  .btn.secondary{ background: linear-gradient(180deg, #232b3b, #1a2230) }
  .checkmark-container { width: 100px; height: 100px; margin: 0 auto 30px; position: relative; }
  .checkmark-circle { stroke-dasharray: 300; stroke-dashoffset: 300; stroke-width: 3; stroke: var(--ok); fill: none; animation: draw-circle 1s ease-in-out forwards; }
  .checkmark { stroke-dasharray: 100; stroke-dashoffset: 100; stroke-width: 4; stroke: var(--ok); stroke-linecap: round; stroke-linejoin: round; fill: none; animation: draw-check 0.8s ease-in-out 0.8s forwards; }
  @keyframes draw-circle { to { stroke-dashoffset: 0; } }
  @keyframes draw-check { to { stroke-dashoffset: 0; } }
  .confirmation-text { font-size: 24px; margin-bottom: 15px; color: var(--ok); font-weight: 600; }
  .order-details { background: rgba(255, 255, 255, 0.03); border-radius: 12px; padding: 20px; margin: 25px 0; text-align: left; }
  .detail-row { display: flex; justify-content: space-between; margin-bottom: 10px; }
  .detail-label { color: var(--muted); }
  .detail-value { font-weight: 500; }
  .note { font-size: 14px; color: var(--muted); margin-top: 25px; line-height: 1.5; }
  .footer{ opacity:.85; margin-top:40px; padding:16px; text-align:center; font-size:13px; color:var(--muted) }
  .user-verification { display: flex; flex-direction: column; align-items: center; gap: 20px; margin: 25px 0; }
  .user-info { display: flex; align-items: center; gap: 15px; background: rgba(255, 255, 255, 0.03); padding: 15px; border-radius: 12px; width: 100%; max-width: 350px; }
  .user-avatar { width: 60px; height: 60px; border-radius: 50%; background: linear-gradient(45deg, #6de1ff, #7c6dff); display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 24px; overflow: hidden; }
  .user-avatar img { width: 100%; height: 100%; object-fit: cover; }
  .user-details { text-align: left; }
  .username { font-weight: 600; margin-bottom: 5px; }
  .user-id { font-size: 12px; color: var(--muted); }
  .verification-buttons { display: flex; gap: 15px; margin-top: 10px; }
  .not-me { color: var(--accent); cursor: pointer; text-decoration: underline; margin-top: 15px; }
  .hidden { display: none !important; }
  .error-message { color: var(--danger); padding: 15px; background: rgba(255, 107, 107, 0.1); border-radius: 12px; margin: 20px 0; text-align: center; }
  .loading-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg); display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 9999; }
  .loading-spinner { width: 50px; height: 50px; border: 3px solid rgba(109, 225, 255, 0.3); border-radius: 50%; border-top-color: var(--accent); animation: spin 1s ease-in-out infinite; margin-bottom: 20px; }
  @keyframes spin { to { transform: rotate(360deg); } }
  .login-prompt { text-align: center; padding: 20px; }
  .discord-login-btn { display: inline-flex; align-items: center; gap: 10px; background: #5865F2; color: white; padding: 12px 20px; border-radius: 12px; text-decoration: none; font-weight: 600; margin-top: 20px; transition: all 0.2s ease; }
  .discord-login-btn:hover { background: #4752c4; transform: translateY(-2px); }
  .loading-dots::after { content: ''; animation: dots 1.5s infinite; }
  @keyframes dots { 0%, 20% { content: '.'; } 40% { content: '..'; } 60%, 100% { content: '...'; } }
</style>
</head>
<body>
<div class="stars"></div><div class="stars2"></div><div class="stars3"></div>

<div id="loadingScreen" class="loading-screen">
  <div class="loading-spinner"></div>
  <div class="loading-text">Vérification en cours<span class="loading-dots"></span></div>
</div>

<div class="wrap">
  <div class="brand">
    <div class="logo" aria-hidden="true"></div>
    <div>
      <h1>NazAPI • Confirmation</h1>
      <div class="muted" style="font-size:13px; text-align: center;">Merci pour votre confiance</div>
    </div>
  </div>

  <div class="card" id="cardRoot">
    <div id="errorSection" class="hidden">
      <div class="error-message">
        <h2>Accès non autorisé</h2>
        <p>Cette page est réservée aux utilisateurs ayant complété un paiement.</p>
      </div>
      <button class="btn ok" onclick="window.location.href='/'">Retour à l'accueil</button>
    </div>
    
    <div id="loginSection" class="hidden">
      <h2 style="margin-bottom: 20px;">Connexion requise</h2>
      <p class="muted">Veuillez vous connecter avec Discord pour confirmer votre achat.</p>
      <div class="login-prompt">
        <a href="#" id="discordLoginBtn" class="discord-login-btn">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
            <path d="M19.27 5.33C17.94 4.71 16.5 4.26 15 4a.09.09 0 0 0-.07.03c-.18.33-.39.76-.53 1.09a16.09 16.09 0 0 0-4.8 0c-.14-.34-.35-.76-.54-1.09c-.01-.02-.04-.03-.07-.03c-1.5.26-2.93.71-4.27 1.33c-.01 0-.02.01-.03.02C2.44 8.78 1.71 12.23 2.04 15.64c0 .02.01.04.03.05c1.57 1.15 3.1 1.84 4.59 2.3c.03.01.06 0 .07-.02c.4-.55.76-1.13 1.07-1.74c.02-.04 0-.08-.04-.09c-.57-.22-1.11-.48-1.64-.78c-.04-.02-.04-.08-.01-.11c.11-.08.22-.17.33-.25c.02-.02.05-.02.07-.01c3.44 1.57 7.15 1.57 10.55 0c.02-.01.05-.01.07.01c.11.09.22.17.33.26c.04.03.04.09-.01.11c-.52.31-1.07.56-1.64.78c-.04.01-.05.06-.04.09c.32.61.67 1.19 1.07 1.74c.03.01.06.02.09.01c1.5-.46 3.02-1.15 4.59-2.3c.02-.01.03-.03.03-.05c.4-3.9-.67-7.25-2.73-10.29c-.01-.02-.02-.02-.04-.02zm-10.56 8.18c-1.03 0-1.89-.95-1.89-2.12s.84-2.12 1.89-2.12c1.06 0 1.9.96 1.89 2.12c0 1.17-.84 2.12-1.89 2.12zm6.59 0c-1.03 0-1.89-.95-1.89-2.12s.84-2.12 1.89-2.12c1.06 0 1.9.96 1.89 2.12c0 1.17-.83 2.12-1.89 2.12z"/>
          </svg>
          Se connecter avec Discord
        </a>
      </div>
    </div>
    
    <div id="verificationSection" class="hidden">
      <h2 style="margin-bottom: 20px;">Confirmation de paiement</h2>
      <p class="muted">Nous avons besoin de confirmer votre identité pour finaliser votre achat.</p>
      <div class="user-verification">
        <div class="user-info">
          <div class="user-avatar" id="userAvatar">
            <img id="avatarImage" src="" alt="Avatar" onerror="this.style.display='none';">
            <span id="avatarInitial">U</span>
          </div>
          <div class="user-details">
            <div class="username" id="username">Utilisateur</div>
            <div class="user-id" id="userId">ID: Chargement...</div>
          </div>
        </div>
        <div style="text-align: center;">
          <div style="margin-bottom: 10px; font-weight: 500;">Est-ce vous ?</div>
          <div class="verification-buttons">
            <button class="btn ok" id="confirmButton">Oui, c'est moi</button>
            <button class="btn secondary" id="cancelButton">Non, ce n'est pas moi</button>
          </div>
          <div class="not-me" id="notMeLink">Non, déconnectez-moi</div>
        </div>
      </div>
    </div>
    
    <div id="confirmationSection" class="hidden">
      <div class="checkmark-container">
        <svg viewBox="0 0 100 100">
          <circle class="checkmark-circle" cx="50" cy="50" r="45" />
          <path class="checkmark" d="M30,50 L45,65 L70,35" />
        </svg>
      </div>
      <div class="confirmation-text">Merci pour votre achat !</div>
      <p class="muted">Voici votre clé de licence. Elle expire dans une heure si elle n'est pas utilisée.</p>
      <div class="order-details">
        <div class="detail-row"><span class="detail-label">Produit:</span><span class="detail-value">NazAPI Premium</span></div>
        <div class="detail-row"><span class="detail-label">Durée:</span><span class="detail-value">30 jours</span></div>
        <div class="detail-row"><span class="detail-label">Clé de licence:</span><span class="detail-value" id="licenseKey">—</span></div>
        <div class="detail-row"><span class="detail-label">Date d'activation:</span><span class="detail-value" id="activationDate">—</span></div>
        <div class="detail-row"><span class="detail-label">Expiration:</span><span class="detail-value" id="expirationDate">—</span></div>
      </div>
      <p class="note">Copiez votre clé de licence ci-dessus et utilisez-la pour activer votre abonnement. <a href="/" class="muted">Plus d'informations ici.</a></p>
      <button class="btn ok" onclick="window.location.href='/'">Retour à l'accueil</button>
    </div>
  </div>

  <footer class="footer">
    <div>© <span id="year"></span> NazAPI • <span class="muted">research services ✦</span></div>
  </footer>
</div>

<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
<script>
  // This value is provided by the canvas environment.
  const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

  // ====================
  // Firebase Configuration
  // ====================
  const firebaseConfig = {
    apiKey: "AIzaSyBtVmI_0_9qC6Cj5lmYgbwVJlW8lH11Ouw",
    authDomain: "nazapi-fc74e.firebaseapp.com",
    projectId: "nazapi-fc74e",
    storageBucket: "nazapi-fc74e.firebasestorage.app",
    messagingSenderId: "1011679210688",
    appId: "1:1011679210688:web:eeccc40063f83b91e3d125",
    measurementId: "G-522271ZX8N"
  };
  const app = firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();
  
  // ====================
  // Config
  // ====================
  const DISCORD = {
    CLIENT_ID: '1407764995671986249',
    REDIRECT_URI: window.location.origin + window.location.pathname, // stay on this page
    SCOPES: ['identify', 'guilds.members.read'],
    GUILD_ID: '1406489247543984240',
    PREMIUM_ROLE_ID: '1406489247573086400'
  };

  // ====================
  // State
  // ====================
  let discordAuth = null;
  let discordUser = null;

  // ====================
  // Utils
  // ====================
  const qs = sel => document.querySelector(sel);

  function hideLoadingScreen() {
    const el = qs('#loadingScreen');
    if (el) el.classList.add('hidden');
  }

  function showOnly(sectionId) {
    // Hide all direct child divs of the card
    const root = qs('#cardRoot');
    if (!root) return;
    root.querySelectorAll(':scope > div').forEach(d => d.classList.add('hidden'));
    const target = qs('#' + sectionId);
    if (target) target.classList.remove('hidden');
  }

  function saveSession() {
    try {
      if (discordAuth) sessionStorage.setItem('nazapi_discord_auth', JSON.stringify(discordAuth));
      if (discordUser) sessionStorage.setItem('nazapi_discord_user', JSON.stringify(discordUser));
    } catch {}
  }

  function loadSession() {
    try {
      const a = sessionStorage.getItem('nazapi_discord_auth');
      const u = sessionStorage.getItem('nazapi_discord_user');
      if (a) discordAuth = JSON.parse(a);
      if (u) discordUser = JSON.parse(u);
    } catch {}
  }

  function storePaymentCompleted(id) {
    if (id) sessionStorage.setItem('nazapi_payment_completed', id);
  }
  function getStoredPaymentCompleted() {
    return sessionStorage.getItem('nazapi_payment_completed');
  }

  // Parse Discord implicit grant; also read "state"
  function parseImplicitTokenAndState() {
    if (!location.hash || !location.hash.startsWith('#')) return null;
    const h = new URLSearchParams(location.hash.slice(1));
    const token = h.get('access_token');
    if (!token) return null;
    const tokenType = h.get('token_type') || 'Bearer';
    const expires = Number(h.get('expires_in') || 0);
    const state = h.get('state') || '';

    // Clean hash
    history.replaceState({}, document.title, location.pathname + location.search);
    return { token, tokenType, expires, state };
  }

  async function fetchDiscordJSON(token, path) {
    const r = await fetch(`https://discord.com/api${path}`, {
      headers: { Authorization: `Bearer ${token}` }
    });
    if (!r.ok) throw new Error('Discord API error: ' + r.status);
    return r.json();
  }

  function buildDiscordOAuthURL(extraState = '') {
    const params = new URLSearchParams({
      client_id: DISCORD.CLIENT_ID,
      response_type: 'token',
      redirect_uri: DISCORD.REDIRECT_URI,
      scope: DISCORD.SCOPES.join(' '),
      state: extraState // we’ll pass payment_completed in here too
    });
    return `https://discord.com/oauth2/authorize?${params.toString()}`;
  }

  function loginDiscord(paymentCompletedId) {
    // Preserve payment intent id via state and sessionStorage
    const pc = paymentCompletedId || getStoredPaymentCompleted() || new URLSearchParams(location.search).get('payment_completed') || '';
    storePaymentCompleted(pc);
    const state = pc ? `pc=${encodeURIComponent(pc)}` : '';
    window.location.href = buildDiscordOAuthURL(state);
  }

  function logout() {
    discordAuth = null;
    discordUser = null;
    sessionStorage.removeItem('nazapi_discord_auth');
    sessionStorage.removeItem('nazapi_discord_user');
    // keep payment id so user can re-login
    window.location.href = '/';
  }

  async function updateFromDiscord(token) {
    discordUser = await fetchDiscordJSON(token, '/users/@me');
    saveSession();
    return true;
  }

  // Simulated role assignment (replace with your backend call)
  async function assignDiscordRole(userId) {
    // TODO: call your real backend/cloud function here
    // This is a placeholder for your Discord bot to handle the role assignment
    await new Promise(r => setTimeout(r, 1200));
    return true;
  }
  
  // --- START NEW CODE ---
  // A helper function to generate the license key using cryptographically secure random values
  function generateLicenseKey() {
    const crypto = window.crypto || window.msCrypto;
    if (crypto && crypto.getRandomValues) {
      const arr = new Uint8Array(16);
      crypto.getRandomValues(arr);
      return Array.from(arr, byte => byte.toString(16).padStart(2, '0')).join('').toUpperCase();
    }
    // Fallback for browsers that don't support the Crypto API
    console.warn('Using insecure fallback for key generation. Please update your browser.');
    return Math.random().toString(36).substring(2, 18).toUpperCase() + Math.random().toString(36).substring(2, 18).toUpperCase();
  }

  // Function to generate a key and save it to the licenses collection
  async function createAndSaveLicenseKey() {
    const licensesRef = db.collection(`artifacts/${appId}/public/data/licenses`);
    const generatedKey = generateLicenseKey();
    const now = Date.now();
    const durationDays = 30; // Matches "30 jours" in the HTML
    const expirationMs = durationDays * 24 * 60 * 60 * 1000;
    const unusedExpiresAtMs = 3600000; // 1 hour in milliseconds

    const keyData = {
      key: generatedKey,
      name: 'NazAPI Premium',
      expiresAt: now + expirationMs,
      status: 'unused',
      createdAt: now,
      activatedBy: null,
      source: 'website', // Use 'website' to distinguish from bot-generated keys
      unusedExpiresAt: now + unusedExpiresAtMs
    };

    try {
      await licensesRef.add(keyData);
      console.log('Successfully saved license key to Firestore:', generatedKey);
      return { key: generatedKey, expirationDate: new Date(keyData.expiresAt) };
    } catch (error) {
      console.error('Error saving license key:', error);
      return { key: null, expirationDate: null };
    }
  }
  // --- END NEW CODE ---

  // ====================
  // Main
  // ====================
  document.addEventListener('DOMContentLoaded', async () => {
    qs('#year').textContent = new Date().getFullYear();

    let paymentCompleted = new URLSearchParams(location.search).get('payment_completed');
    // If we just returned from Discord, parse token + state
    const parsed = parseImplicitTokenAndState();
    if (parsed) {
      discordAuth = { token: parsed.token, tokenType: parsed.tokenType, expires: parsed.expires };
      // If state carried our payment id, restore it
      if (parsed.state && parsed.state.startsWith('pc=')) {
        const pc = decodeURIComponent(parsed.state.slice(3));
        if (pc) {
          storePaymentCompleted(pc);
          paymentCompleted = pc;
        }
      }
    } else {
      loadSession();
    }

    // If URL lost the payment id but we have it stored, put it back into the URL for consistency
    if (!paymentCompleted) {
      const stored = getStoredPaymentCompleted();
      if (stored) {
        paymentCompleted = stored;
        const url = new URL(location.href);
        url.searchParams.set('payment_completed', stored);
        history.replaceState({}, document.title, url.toString());
      }
    } else {
      storePaymentCompleted(paymentCompleted);
    }

    // Always hide loader in the end
    try {
      // Check Firestore for payment existence and used status
      if (!paymentCompleted || !/^pi_[A-Za-z0-9_]+$/.test(paymentCompleted)) {
        showOnly('errorSection');
        return;
      }
      
      const paymentRef = db.collection('payments').doc(paymentCompleted);
      const paymentDoc = await paymentRef.get();

      if (!paymentDoc.exists) {
        // If payment doesn't exist, show error
        showOnly('errorSection');
        return;
      }

      const paymentData = paymentDoc.data();
      if (paymentData.used) {
        // If payment is already used, redirect home
        window.location.href = '/';
        return;
      }
      
      // If not authenticated, ask for login
      const isAuthenticated = !!(discordAuth && discordAuth.token);
      if (!isAuthenticated) {
        showOnly('loginSection');
        const btn = qs('#discordLoginBtn');
        if (btn) btn.addEventListener('click', (e) => {
          e.preventDefault();
          loginDiscord(paymentCompleted);
        });
        return;
      }

      // We have token; ensure we have the user
      if (!discordUser) {
        try {
          await updateFromDiscord(discordAuth.token);
        } catch (e) {
          // token may be invalid: clear and ask login again
          sessionStorage.removeItem('nazapi_discord_auth');
          showOnly('loginSection');
          const btn = qs('#discordLoginBtn');
          if (btn) btn.addEventListener('click', (ev) => {
            ev.preventDefault();
            loginDiscord(paymentCompleted);
          });
          return;
        }
      }

      // Show verification
      showOnly('verificationSection');

      // Fill user info
      qs('#username').textContent = `${discordUser.username}#${discordUser.discriminator || '0'}`;
      qs('#userId').textContent = `ID: ${discordUser.id}`;

      const avatarImage = qs('#avatarImage');
      const avatarInitial = qs('#avatarInitial');
      if (discordUser.avatar) {
        avatarImage.src = `https://cdn.discordapp.com/avatars/${discordUser.id}/${discordUser.avatar}.png`;
        avatarImage.style.display = 'block';
        avatarInitial.style.display = 'none';
      } else {
        avatarImage.style.display = 'none';
        avatarInitial.textContent = discordUser.username.charAt(0).toUpperCase();
        avatarInitial.style.display = 'block';
      }

      // Handlers
      const confirmBtn = qs('#confirmButton');
      if (confirmBtn) {
        confirmBtn.addEventListener('click', async function() {
          const original = this.textContent;
          this.textContent = 'Traitement…';
          this.disabled = true;
          try {
            // Update payment status to 'used' and link to Discord user ID
            await paymentRef.update({
              used: true,
              discordId: discordUser.id,
              usedAt: firebase.firestore.FieldValue.serverTimestamp()
            });

            // Generate and save a new license key to the licenses collection
            const { key: licenseKey, expirationDate } = await createAndSaveLicenseKey();

            if (!licenseKey) {
              throw new Error('Failed to generate license key.');
            }
            
            // Show confirmation with key
            showOnly('confirmationSection');
            qs('#licenseKey').textContent = licenseKey;
            
            // Dates for confirmation screen
            const now = new Date();
            const options = { day: 'numeric', month: 'long', year: 'numeric' };
            qs('#activationDate').textContent = now.toLocaleDateString('fr-FR', options);
            qs('#expirationDate').textContent = expirationDate.toLocaleDateString('fr-FR', options);
            
          } catch (e) {
            console.error(e);
            alert('Une erreur est survenue. Veuillez réessayer.');
            this.textContent = original;
            this.disabled = false;
          }
        });
      }

      const cancelBtn = qs('#cancelButton');
      if (cancelBtn) {
        cancelBtn.addEventListener('click', () => loginDiscord(paymentCompleted));
      }

      const notMe = qs('#notMeLink');
      if (notMe) notMe.addEventListener('click', logout);

    } catch (err) {
      console.error('Fatal error:', err);
      showOnly('errorSection');
    } finally {
      hideLoadingScreen();
    }
  });

  // Safety net
  setTimeout(hideLoadingScreen, 5000);
</script>
</body>
</html>
